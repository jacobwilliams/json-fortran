<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="JSON-Fortran â€“ A Fortran 2008 JSON API">
    
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>json_module.F90 &ndash; JSON-Fortran</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">JSON-Fortran <small>4.3.0</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
                
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
				
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>json_module.F90
    <small>Source File</small>
    
    </h1>
	 
<div class="row">
<div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
    <li><i class="fa fa-code"></i><a href="../src/json_module.F90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">json_module.F90</li>
  </ol>
</div>
</div>
</div>
    
  </div>
  <div class="row">
    <div class="col-lg-3">
    
<div id="sidebar">
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods">Modules</a></h3></div>
    <div id="mods" class="panel-collapse collapse">
        <div class="list-group">
          
          <a class="list-group-item" href="../module/json_module.html">json_module</a>
          
        </div>
    </div>
  </div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
    <div class="list-group">
      <a class="list-group-item" href="../sourcefile/json_module.f90.html#src">json_module.F90</a>
    </div>
  </div>
  
  <hr>
  
  <div class="panel panel-default">
    <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles">All Source Files</a></h3></div>
    <div id="allfiles" class="panel-collapse collapse">
        <div class="list-group">
          
          <a class="list-group-item" href="../sourcefile/jf_test_1.f90.html">jf_test_1.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_10.f90.html">jf_test_10.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_11.f90.html">jf_test_11.F90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_12.f90.html">jf_test_12.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_13.f90.html">jf_test_13.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_14.f90.html">jf_test_14.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_2.f90.html">jf_test_2.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_3.f90.html">jf_test_3.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_4.f90.html">jf_test_4.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_5.f90.html">jf_test_5.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_6.f90.html">jf_test_6.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_7.f90.html">jf_test_7.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_8.f90.html">jf_test_8.f90</a>
          
          <a class="list-group-item" href="../sourcefile/jf_test_9.f90.html">jf_test_9.f90</a>
          
          <a class="list-group-item" href="../sourcefile/json_module.f90.html">json_module.F90</a>
          
          <a class="list-group-item" href="../sourcefile/test_iso_10646_support.f90.html">test_iso_10646_support.f90</a>
          
        </div>
    </div>
  </div>
  
</div>

    </div>
    <div class="col-lg-9" id='text'>
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  license: BSD</span>
<span class="c">!</span>
<span class="c">!# JSON-Fortran:</span>
<span class="c">!  A Fortran 2008 JSON (JavaScript Object Notation) API.</span>
<span class="c">!</span>
<span class="c">!  [TOC]</span>
<span class="c">!</span>
<span class="c">!  This module provides an interface for reading and writing JSON files.</span>
<span class="c">!</span>
<span class="c">!@note ```-DUSE_UCS4``` is an optional preprocessor flag.</span>
<span class="c">!      When present, Unicode support is enabled. Note that this</span>
<span class="c">!      is currently only supported with the gfortran compiler.</span>
<span class="c">!      Example: ```gfortran -DUSE_UCS4 ... ```</span>
<span class="cp">#ifdef USE_UCS4</span>
<span class="cp">#  pragma push_macro(&quot;USE_UCS4&quot;)</span>
<span class="cp">#  undef USE_UCS4</span>
<span class="c">!      The documentation given here assumes ```USE_UCS4``` **is** defined.</span>
<span class="cp">#  pragma pop_macro(&quot;USE_UCS4&quot;)</span>
<span class="cp">#else</span>
<span class="c">!      The documentation given here assumes ```USE_UCS4``` **is not** defined.</span>
<span class="cp">#endif</span>
<span class="c">!</span>
<span class="c">!@warning ```CK``` and ```CDK``` are the JSON-Fortran character kind and JSON-Fortran default</span>
<span class="c">!         character kind respectively. Client code **MUST** ensure characters of ```kind=CK```</span>
<span class="c">!         are used for all character variables and strings passed to the JSON-Fortran</span>
<span class="c">!         library *EXCEPT* for file names which must be of ```&#39;DEFAULT&#39;``` character kind,</span>
<span class="c">!         provided here as ```CDK```. In particular, any variable that is a: json path, string</span>
<span class="c">!         value or object name passed to the JSON-Fortran library **MUST** be of type ```CK```.</span>
<span class="c">!</span>
<span class="c">!@note Most string literal constants of default kind are fine to pass as arguments to</span>
<span class="c">!      JSON-Fortran procedures since they have been overloaded to accept ```intent(in)```</span>
<span class="c">!      character arguments of the default (```CDK```) kind. If you find a procedure which does</span>
<span class="c">!      not accept an ```intent(in)``` literal string argument of default kind, please</span>
<span class="c">!      [file an issue](https://github.com/jacobwilliams/json-fortran/issues/new) on github.</span>
<span class="c">!</span>
<span class="c">!## License</span>
<span class="c">!</span>
<span class="c">!  **JSON-Fortran License:**</span>
<span class="c">!</span>
<span class="c">!    JSON-Fortran: A Fortran 2008 JSON API</span>
<span class="c">!</span>
<span class="c">!    http://github.com/jacobwilliams/json-fortran</span>
<span class="c">!</span>
<span class="c">!    Copyright (c) 2014-2015, Jacob Williams</span>
<span class="c">!</span>
<span class="c">!    All rights reserved.</span>
<span class="c">!</span>
<span class="c">!    Redistribution and use in source and binary forms, with or without modification,</span>
<span class="c">!    are permitted provided that the following conditions are met:</span>
<span class="c">!    * Redistributions of source code must retain the above copyright notice, this</span>
<span class="c">!      list of conditions and the following disclaimer.</span>
<span class="c">!    * Redistributions in binary form must reproduce the above copyright notice, this</span>
<span class="c">!      list of conditions and the following disclaimer in the documentation and/or</span>
<span class="c">!      other materials provided with the distribution.</span>
<span class="c">!    * The names of its contributors may not be used to endorse or promote products</span>
<span class="c">!      derived from this software without specific prior written permission.</span>
<span class="c">!    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="c">!    ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c">!    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c">!    DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="c">!    ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c">!    (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c">!    LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="c">!    ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c">!    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c">!    SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c">!</span>
<span class="c">!  **Original FSON License:**</span>
<span class="c">!</span>
<span class="c">!    Copyright (c) 2012 Joseph A. Levin</span>
<span class="c">!</span>
<span class="c">!    Permission is hereby granted, free of charge, to any person obtaining a copy of this</span>
<span class="c">!    software and associated documentation files (the &quot;Software&quot;), to deal in the Software</span>
<span class="c">!    without restriction, including without limitation the rights to use, copy, modify, merge,</span>
<span class="c">!    publish, distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<span class="c">!    persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<span class="c">!</span>
<span class="c">!    The above copyright notice and this permission notice shall be included in all copies or</span>
<span class="c">!    substantial portions of the Software.</span>
<span class="c">!</span>
<span class="c">!    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,</span>
<span class="c">!    INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR</span>
<span class="c">!    PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE</span>
<span class="c">!    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT</span>
<span class="c">!    OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="c">!    DEALINGS IN THE SOFTWARE.</span>
<span class="c">!</span>
<span class="c">!## History</span>
<span class="c">!  * Joseph A. Levin : March 2012 : Original FSON code [retrieved on 12/2/2013].</span>
<span class="c">!  * Jacob Williams : 2/8/2014 : Extensive modifications to the original FSON code.</span>
<span class="c">!    The original F95 code was split into four files:</span>
<span class="c">!    fson_path_m.f95, fson_string_m.f95, fson_value_m.f95, and fson.f95.</span>
<span class="c">!    The new code has been extensively updated, refactored and combined into this</span>
<span class="c">!    one module (json_module.f90).</span>
<span class="c">!    Various Fortran 2003/2008 features are now used</span>
<span class="c">!    (e.g., allocatable strings, newunit, generic, class, and abstract interface).</span>
<span class="c">!  * Development continues at: [Github](http://github.com/jacobwilliams/json-fortran)</span>
<span class="c">!</span>
<span class="c">!## See also</span>
<span class="c">!  * [json-fortran development site](http://github.com/jacobwilliams/json-fortran)</span>
<span class="c">!  * [json-fortran online documentation](http://jacobwilliams.github.io/json-fortran)</span>
<span class="c">!  * [JSON website](http://www.json.org/)</span>
<span class="c">!  * [JSON validator](http://jsonlint.com/)</span>

    <span class="k">module </span><span class="n">json_module</span>

    <span class="k">use</span><span class="p">,</span><span class="k">intrinsic</span> <span class="kd">::</span> <span class="n">iso_fortran_env</span>

    <span class="k">implicit none</span>

<span class="k">    private</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">RK</span> <span class="o">=</span> <span class="n">real64</span>  <span class="c">!! Default real kind [8 bytes]</span>

    <span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">IK</span> <span class="o">=</span> <span class="n">int32</span>   <span class="c">!! Default integer kind [4 bytes].</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Processor dependendant &#39;DEFAULT&#39; character kind.</span>
    <span class="c">!  This is 1 byte for the Intel and Gfortran compilers.</span>

    <span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">CDK</span> <span class="o">=</span> <span class="nb">selected_char_kind</span><span class="p">(</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">)</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Default logical kind.</span>
    <span class="c">!  This is 4 bytes for the Intel and Gfortran compilers</span>
    <span class="c">!  (and perhaps others).</span>
    <span class="c">!  The declaration ensures a valid kind</span>
    <span class="c">!  if the compiler doesn&#39;t have a logical_kinds(3).</span>
    <span class="c">!</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">LK</span> <span class="o">=</span> <span class="n">logical_kinds</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">logical_kinds</span><span class="p">)))</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  String kind preprocessor macro.</span>
    <span class="c">!</span>
<span class="cp">#if defined __GFORTRAN__ &amp;&amp; defined USE_UCS4</span>
    <span class="c">! gfortran compiler AND UCS4 support requested:</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">json_fortran_string_kind</span> <span class="o">=</span> <span class="s1">&#39;ISO_10646&#39;</span>
<span class="cp">#else</span>
    <span class="c">! this is the string kind to use unless compiling with GFortran AND</span>
    <span class="c">! UCS4/ISO 10646 support is requested</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">json_fortran_string_kind</span> <span class="o">=</span> <span class="s1">&#39;DEFAULT&#39;</span>
<span class="cp">#endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Default character kind used by JSON-Fortran.</span>
    <span class="c">!  If ISO 10646 (UCS4) support is available, use that,</span>
    <span class="c">!  otherwise, gracefully fall back on &#39;DEFAULT&#39; characters.</span>
    <span class="c">!  Currently only gfortran &gt;= 4.9.2 will correctly support</span>
    <span class="c">!  UCS4 which is stored in 4 bytes.</span>
    <span class="c">!  (and perhaps others).</span>

    <span class="kt">integer</span><span class="p">,</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">CK</span> <span class="o">=</span> <span class="nb">selected_char_kind</span><span class="p">(</span><span class="n">json_fortran_string_kind</span><span class="p">)</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">! File encoding preprocessor macro.</span>
    <span class="c">!</span>
<span class="cp">#if defined __GFORTRAN__ &amp;&amp; defined USE_UCS4</span>
    <span class="c">! gfortran compiler AND UCS4 support requested, &amp; silence redefine warning:</span>
    <span class="c">! Make sure we output files with utf-8 encoding too</span>
<span class="cp">#define FILE_ENCODING ,encoding=&#39;UTF-8&#39;</span>
<span class="cp">#else</span>
    <span class="c">! don&#39;t ask for utf-8 file encoding unless using UCS4</span>
    <span class="c">! this may let us use unformatted stream io to read in files more quickly</span>
    <span class="c">! even with unicode support turned on `inquire( ... encoding=FL_ENCODING)`</span>
    <span class="c">! may be able to detect json files in which each character is exactly one</span>
    <span class="c">! byte</span>
<span class="cp">#define FILE_ENCODING</span>
<span class="cp">#endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">! This C preprocessor macro will take a procedure name as an</span>
    <span class="c">! input, and output either that same procedure name if the</span>
    <span class="c">! code is compiled without USE_UCS4 being defined or it will</span>
    <span class="c">! expand the procedure name to the original procedure name,</span>
    <span class="c">! followed by a comma and then the original procedure name</span>
    <span class="c">! with &#39;wrap_&#39; prepended to it. This is suitable for creating</span>
    <span class="c">! overloaded interfaces that will accept UCS4 character actual</span>
    <span class="c">! arguments as well as DEFAULT/ASCII character arguments,</span>
    <span class="c">! based on whether or not ISO 10646 is supported and requested.</span>
    <span class="c">!</span>
<span class="cp"># ifdef USE_UCS4</span>
<span class="cp">#   ifdef __GFORTRAN__</span>
    <span class="c">! gfortran uses cpp in old-school compatibility mode so</span>
    <span class="c">! the # stringify and ## concatenate operators don&#39;t work</span>
    <span class="c">! but we can use C/C++ style comment to ensure PROCEDURE is</span>
    <span class="c">! correctly tokenized and prepended with &#39;wrap_&#39; when the</span>
    <span class="c">! macro is expanded</span>
<span class="cp">#     define MAYBEWRAP(PROCEDURE) PROCEDURE , wrap_/**/PROCEDURE</span>
<span class="cp">#   endif</span>
<span class="c">!   ifdef __INTEL_COMPILER</span>
    <span class="c">! Intel&#39;s fpp does support the more contemporary ## concatenation</span>
    <span class="c">! operator, but doesn&#39;t treat the C/C++ comments the same way.</span>
    <span class="c">! If you use the gfortran approach and pass the -noB switch to</span>
    <span class="c">! fpp, the macro will expand, but with a space between wrap_ and</span>
    <span class="c">! whatever PROCEDURE expands to</span>
    <span class="c">! Intel doesn&#39;t support ISO 10646 yet, but this is here to</span>
    <span class="c">! ease the transition once they do.</span>
<span class="c">!     define MAYBEWRAP(PROCEDURE) PROCEDURE , wrap_##PROCEDURE</span>
<span class="c">!   endif</span>
<span class="cp"># else</span>
<span class="cp">#   define MAYBEWRAP(PROCEDURE) PROCEDURE</span>
<span class="cp"># endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  If Unicode is not enabled, then</span>
    <span class="c">!  JSON files are opened using access=&#39;STREAM&#39; and</span>
    <span class="c">!  form=&#39;UNFORMATTED&#39;.  This allows the file to</span>
    <span class="c">!  be read faster.</span>
    <span class="c">!</span>
<span class="cp">#ifdef USE_UCS4</span>
    <span class="kt">logical</span><span class="p">,</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">use_unformatted_stream</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="cp">#else</span>
    <span class="kt">logical</span><span class="p">,</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">use_unformatted_stream</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="cp">#endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  If Unicode is not enabled, then</span>
    <span class="c">!  JSON files are opened using access=&#39;STREAM&#39; and</span>
    <span class="c">!  form=&#39;UNFORMATTED&#39;.  This allows the file to</span>
    <span class="c">!  be read faster.</span>
    <span class="c">!</span>
<span class="cp">#ifdef USE_UCS4</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">access_spec</span> <span class="o">=</span> <span class="s1">&#39;SEQUENTIAL&#39;</span>
<span class="cp">#else</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">access_spec</span> <span class="o">=</span> <span class="s1">&#39;STREAM&#39;</span>
<span class="cp">#endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  If Unicode is not enabled, then</span>
    <span class="c">!  JSON files are opened using access=&#39;STREAM&#39; and</span>
    <span class="c">!  form=&#39;UNFORMATTED&#39;.  This allows the file to</span>
    <span class="c">!  be read faster.</span>
    <span class="c">!</span>
<span class="cp">#ifdef USE_UCS4</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">form_spec</span>   <span class="o">=</span> <span class="s1">&#39;FORMATTED&#39;</span>
<span class="cp">#else</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">form_spec</span>   <span class="o">=</span> <span class="s1">&#39;UNFORMATTED&#39;</span>
<span class="cp">#endif</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!</span>
    <span class="c">!  The types of JSON data.</span>
    <span class="c">!</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_unknown</span>   <span class="o">=</span> <span class="mi">0</span>  <span class="c">!! Unknown JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_null</span>      <span class="o">=</span> <span class="mi">1</span>  <span class="c">!! Null JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_object</span>    <span class="o">=</span> <span class="mi">2</span>  <span class="c">!! Object JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_array</span>     <span class="o">=</span> <span class="mi">3</span>  <span class="c">!! Array JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_logical</span>   <span class="o">=</span> <span class="mi">4</span>  <span class="c">!! Logical JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_integer</span>   <span class="o">=</span> <span class="mi">5</span>  <span class="c">!! Integer JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_double</span>    <span class="o">=</span> <span class="mi">6</span>  <span class="c">!! Double JSON data type</span>
                                                        <span class="c">!! (see [[json_file_variable_info]] and [[json_info]])</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_string</span>    <span class="o">=</span> <span class="mi">7</span>  <span class="c">!! String JSON data type</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Type used to construct the linked-list JSON structure.</span>
    <span class="c">!  Normally, this should always be a pointer variable.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!  The following test program:</span>
    <span class="c">!```fortran</span>
    <span class="c">!    program test</span>
    <span class="c">!     use json_module</span>
    <span class="c">!     implicit none</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_initialize()         !initialize the module</span>
    <span class="c">!     call json_create_object(p,&#39;&#39;)  !create the root</span>
    <span class="c">!     call json_add(p,&#39;year&#39;,1805)   !add some data</span>
    <span class="c">!     call json_add(p,&#39;value&#39;,1.0d0) !add some data</span>
    <span class="c">!     call json_print(p,&#39;test.json&#39;) !write it to a file</span>
    <span class="c">!     call json_destroy(p)           !cleanup</span>
    <span class="c">!    end program test</span>
    <span class="c">!```</span>
    <span class="c">!  Produces the JSON file **test.json**:</span>
    <span class="c">!```json</span>
    <span class="c">!    {</span>
    <span class="c">!      &quot;year&quot;: 1805,</span>
    <span class="c">!      &quot;value&quot;: 0.1E+1</span>
    <span class="c">!    }</span>
    <span class="c">!```</span>
    <span class="k">type</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_value</span>

        <span class="c">!force the constituents to be stored contiguously</span>
        <span class="c">![note: on Intel, the order of the variables below</span>
        <span class="c">! is significant to avoid the misaligned field warnings]</span>
        <span class="k">sequence</span>

<span class="k">        private</span>

        <span class="c">!for the linked list:</span>
        <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">previous</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! previous item in the list</span>
        <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">next</span>     <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! next item in the list</span>
        <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">parent</span>   <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! parent item of this</span>
        <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">children</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! first child item of this</span>
        <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">tail</span>     <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! last child item of this</span>

        <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! variable name</span>

        <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">allocatable</span>                 <span class="kd">::</span> <span class="n">dbl_value</span>  <span class="c">!! real data for this variable</span>
        <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">log_value</span>  <span class="c">!! logical data for this variable</span>
        <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">str_value</span>  <span class="c">!! string data for this variable</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">int_value</span>  <span class="c">!! integer data for this variable</span>

        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">var_type</span> <span class="o">=</span> <span class="n">json_unknown</span>  <span class="c">!! variable type</span>

        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">private</span> <span class="kd">::</span> <span class="n">n_children</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">!! number of children</span>

    <span class="k">end type </span><span class="n">json_value</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt; author: Jacob Williams</span>
    <span class="c">!  date: 12/9/2013</span>
    <span class="c">!</span>
    <span class="c">!  The json_file is the main public class that is</span>
    <span class="c">!  used to open a file and get data from it.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!    program test</span>
    <span class="c">!    use json_module</span>
    <span class="c">!    implicit none</span>
    <span class="c">!    type(json_file) :: json</span>
    <span class="c">!    integer :: ival</span>
    <span class="c">!    real(real64) :: rval</span>
    <span class="c">!    character(len=:),allocatable :: cval</span>
    <span class="c">!    logical :: found</span>
    <span class="c">!    call json_initialize()</span>
    <span class="c">!    call json%load_file(filename=&#39;myfile.json&#39;)</span>
    <span class="c">!    call json%print_file() !print to the console</span>
    <span class="c">!    call json%get(&#39;var.i&#39;,ival,found)</span>
    <span class="c">!    call json%get(&#39;var.r(3)&#39;,rval,found)</span>
    <span class="c">!    call json%get(&#39;var.c&#39;,cval,found)</span>
    <span class="c">!    call json%destroy()</span>
    <span class="c">!    end program test</span>
    <span class="c">!```</span>

    <span class="k">type</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_file</span>

        <span class="k">private</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!! the JSON structure read from the file</span>

    <span class="k">contains</span>

<span class="k">        procedure</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">load_file</span> <span class="o">=&gt;</span> <span class="n">json_file_load</span>

        <span class="k">generic</span><span class="p">,</span>  <span class="k">public</span> <span class="kd">::</span> <span class="n">load_from_string</span> <span class="o">=&gt;</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_load_from_string</span><span class="p">)</span>

        <span class="k">procedure</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">destroy</span> <span class="o">=&gt;</span> <span class="n">json_file_destroy</span>
        <span class="k">procedure</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">move</span>    <span class="o">=&gt;</span> <span class="n">json_file_move_pointer</span>
        <span class="k">generic</span><span class="p">,</span><span class="k">public</span>   <span class="kd">::</span> <span class="n">info</span>    <span class="o">=&gt;</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_variable_info</span><span class="p">)</span>

        <span class="k">procedure</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">print_to_string</span> <span class="o">=&gt;</span> <span class="n">json_file_print_to_string</span>

        <span class="k">generic</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">print_file</span> <span class="o">=&gt;</span> <span class="n">json_file_print_to_console</span><span class="p">,</span> <span class="p">&amp;</span>
                                        <span class="n">json_file_print_1</span><span class="p">,</span> <span class="p">&amp;</span>
                                        <span class="n">json_file_print_2</span>

        <span class="k">generic</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">get</span> <span class="o">=&gt;</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_object</span><span class="p">),</span>      <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_integer</span><span class="p">),</span>     <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_double</span><span class="p">),</span>      <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_logical</span><span class="p">),</span>     <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_string</span><span class="p">),</span>      <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_integer_vec</span><span class="p">),</span> <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_double_vec</span><span class="p">),</span>  <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_logical_vec</span><span class="p">),</span> <span class="p">&amp;</span>
                                 <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_string_vec</span><span class="p">),</span>  <span class="p">&amp;</span>
                                 <span class="n">json_file_get_root</span>

        <span class="k">generic</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">update</span> <span class="o">=&gt;</span>  <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_integer</span><span class="p">),</span>  <span class="p">&amp;</span>
                                     <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_logical</span><span class="p">),</span>  <span class="p">&amp;</span>
                                     <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_real</span><span class="p">),</span>     <span class="p">&amp;</span>
                                     <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_string</span><span class="p">)</span>
<span class="cp">#     ifdef USE_UCS4</span>
        <span class="k">generic</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">update</span> <span class="o">=&gt;</span> <span class="n">json_file_update_string_name_ascii</span><span class="p">,</span> <span class="p">&amp;</span>
                                    <span class="n">json_file_update_string_val_ascii</span>
<span class="cp">#     endif</span>

        <span class="c">!load from string:</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_load_from_string</span><span class="p">)</span>

        <span class="c">!git info:</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_variable_info</span><span class="p">)</span>

        <span class="c">!get:</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_object</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_integer</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_double</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_logical</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_string</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_integer_vec</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_double_vec</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_logical_vec</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_get_string_vec</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_get_root</span>

        <span class="c">!update:</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_integer</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_logical</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_real</span><span class="p">)</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_file_update_string</span><span class="p">)</span>
<span class="cp">#     ifdef USE_UCS4</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_update_string_name_ascii</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_update_string_val_ascii</span>
<span class="cp">#     endif</span>

        <span class="c">!print_file:</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_print_to_console</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_print_1</span>
        <span class="k">procedure</span> <span class="kd">::</span> <span class="n">json_file_print_2</span>

    <span class="k">end type </span><span class="n">json_file</span>
    <span class="c">!*********************************************************</span>

    <span class="c">!*********************************************************</span>
    <span class="c">!&gt; author: Izaak Beekman</span>
    <span class="c">!  date: 07/23/2015</span>
    <span class="c">!</span>
    <span class="c">!  Structure constructor to initialize a [[json_file(type)]] object</span>
    <span class="c">!  with an existing [[json_value]] object</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">! ...</span>
    <span class="c">! type(json_file)  :: my_file</span>
    <span class="c">! type(json_value) :: json_object</span>
    <span class="c">! ...</span>
    <span class="c">! ! Construct a json_object</span>
    <span class="c">! my_file = json_file(json_object)</span>
    <span class="c">!```</span>
    <span class="k">interface </span><span class="n">json_file</span>
       <span class="k">module procedure </span><span class="n">initialize_json_file</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="k">abstract interface</span>

<span class="k">        subroutine </span><span class="n">array_callback_func</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
            <span class="c">!! Array element callback function.  Used by [[json_get_array]]</span>
            <span class="k">import</span> <span class="kd">::</span> <span class="n">json_value</span><span class="p">,</span><span class="n">IK</span>
            <span class="k">implicit none</span>
<span class="k">            type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span> <span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
            <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
            <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>
        <span class="k">end subroutine </span><span class="n">array_callback_func</span>

        <span class="k">subroutine </span><span class="n">traverse_callback_func</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">finished</span><span class="p">)</span>
            <span class="c">!! Callback function used by [[json_traverse]]</span>
            <span class="k">import</span> <span class="kd">::</span> <span class="n">json_value</span><span class="p">,</span><span class="n">LK</span>
            <span class="k">implicit none</span>
<span class="k">            type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
            <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">finished</span>
        <span class="k">end subroutine </span><span class="n">traverse_callback_func</span>

    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

<span class="cp"># ifdef USE_UCS4</span>
    <span class="c">! Provide a means to convert to UCS4 while concatenating UCS4 and default strings</span>
    <span class="k">interface </span><span class="n">operator</span><span class="p">(</span><span class="o">//</span><span class="p">)</span>
       <span class="k">module procedure </span><span class="n">ucs4_join_default</span><span class="p">,</span> <span class="n">default_join_ucs4</span>
    <span class="k">end interface</span>

    <span class="c">! Provide a string comparison operator that works with mixed kinds</span>
    <span class="k">interface </span><span class="n">operator</span><span class="p">(</span><span class="o">==</span><span class="p">)</span>
       <span class="k">module procedure </span><span class="n">ucs4_comp_default</span><span class="p">,</span> <span class="n">default_comp_ucs4</span>
    <span class="k">end interface</span>
<span class="cp"># endif</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Get a child, either by index or name string.</span>
    <span class="c">!  Both of these return a [[json_value]] pointer.</span>
    <span class="c">!</span>
    <span class="c">!@note Formerly, this was called json_value_get_child</span>

    <span class="k">interface </span><span class="n">json_get_child</span>
        <span class="k">module procedure </span><span class="n">json_value_get_by_index</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_get_by_name_chars</span><span class="p">)</span>
    <span class="k">end interface </span><span class="n">json_get_child</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Add objects to a linked list of [[json_value]]s.</span>
    <span class="c">!</span>
    <span class="c">!@note Formerly, this was called json_value_add</span>

    <span class="k">interface </span><span class="n">json_add</span>
        <span class="k">module procedure </span><span class="n">json_value_add_member</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_integer</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_integer_vec</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_double</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_double_vec</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_logical</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_logical_vec</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_string</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_add_string_vec</span><span class="p">)</span>
<span class="cp">#     ifdef USE_UCS4</span>
        <span class="k">module procedure </span><span class="n">json_value_add_string_name_ascii</span>
        <span class="k">module procedure </span><span class="n">json_value_add_string_val_ascii</span>
        <span class="k">module procedure </span><span class="n">json_value_add_string_vec_name_ascii</span>
        <span class="k">module procedure </span><span class="n">json_value_add_string_vec_val_ascii</span>
<span class="cp">#     endif</span>
    <span class="k">end interface </span><span class="n">json_add</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  These are like [[json_add]], except if a child with the same name is</span>
    <span class="c">!  already present, then its value is simply updated.</span>
    <span class="c">!  Note that currently, these only work for scalar variables.</span>
    <span class="c">!  These routines can also change the variable&#39;s type (but an error will be</span>
    <span class="c">!  thrown if the existing variable is not a scalar).</span>
    <span class="c">!</span>
    <span class="c">!@note It should not be used to change the type of a variable in an array,</span>
    <span class="c">!      or it may result in an invalid JSON file.</span>

    <span class="k">interface </span><span class="n">json_update</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_update_logical</span><span class="p">),&amp;</span>
                         <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_update_double</span><span class="p">),&amp;</span>
                         <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_update_integer</span><span class="p">),&amp;</span>
                         <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_update_string</span><span class="p">)</span>
<span class="cp">#     ifdef USE_UCS4</span>
        <span class="k">module procedure </span><span class="n">json_update_string_name_ascii</span>
        <span class="k">module procedure </span><span class="n">json_update_string_val_ascii</span>
<span class="cp">#     endif</span>
    <span class="k">end interface </span><span class="n">json_update</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Get data from a [[json_value]] linked list.</span>
    <span class="c">!</span>
    <span class="c">!@note There are two versions (e.g. [[json_get_integer]] and [[json_get_integer_with_path]]).</span>
    <span class="c">!      The first one gets the value from the [[json_value]] passed into the routine,</span>
    <span class="c">!      while the second one gets the value from the [[json_value]] found by parsing the</span>
    <span class="c">!      path.  The path version is split up into unicode and non-unicode versions.</span>

    <span class="k">interface </span><span class="n">json_get</span>
        <span class="k">module procedure                       </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_by_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_integer</span><span class="p">,</span>     <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_integer_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_integer_vec</span><span class="p">,</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_integer_vec_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_double</span><span class="p">,</span>      <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_double_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_double_vec</span><span class="p">,</span>  <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_double_vec_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_logical</span><span class="p">,</span>     <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_logical_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_logical_vec</span><span class="p">,</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_logical_vec_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_string</span><span class="p">,</span>      <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_string_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_string_vec</span><span class="p">,</span>  <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_string_vec_with_path</span><span class="p">)</span>
        <span class="k">module procedure </span><span class="n">json_get_array</span><span class="p">,</span>       <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_get_array_with_path</span><span class="p">)</span>
    <span class="k">end interface </span><span class="n">json_get</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Print the json_value structure to an allocatable string.</span>

    <span class="k">interface </span><span class="n">json_print_to_string</span>
        <span class="k">module procedure </span><span class="n">json_value_to_string</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Print the [[json_value]] to a file.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!    type(json_value) :: p</span>
    <span class="c">!    !...</span>
    <span class="c">!    call json_print(p,&#39;test.json&#39;)  !this is [[json_print_2]]</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_print</span>
        <span class="k">module procedure </span><span class="n">json_print_1</span>    <span class="c">!input is unit number</span>
        <span class="k">module procedure </span><span class="n">json_print_2</span>    <span class="c">!input is file name</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Destructor routine for a [[json_value]] pointer.</span>
    <span class="c">!  This must be called explicitly if it is no longer needed,</span>
    <span class="c">!  before it goes out of scope.  Otherwise, a memory leak will result.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!  Destroy the [[json_value]] pointer before the variable goes out of scope:</span>
    <span class="c">!```fortran</span>
    <span class="c">!     subroutine example1()</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create_object(p,&#39;&#39;)</span>
    <span class="c">!     call json_add(p,&#39;year&#39;,2015)</span>
    <span class="c">!     call json_print(p)</span>
    <span class="c">!     call json_destroy(p)</span>
    <span class="c">!     end subroutine example1</span>
    <span class="c">!```</span>
    <span class="c">!</span>
    <span class="c">!  Note: it should NOT be called for a [[json_value]] pointer than has already been</span>
    <span class="c">!  added to another [[json_value]] structure, since doing so may render the</span>
    <span class="c">!  other structure invalid.  Consider the following example:</span>
    <span class="c">!```fortran</span>
    <span class="c">!     subroutine example2(p)</span>
    <span class="c">!     type(json_value),pointer,intent(out) :: p</span>
    <span class="c">!     type(json_value),pointer :: q</span>
    <span class="c">!     call json_create_object(p,&#39;&#39;)</span>
    <span class="c">!     call json_add(p,&#39;year&#39;,2015)</span>
    <span class="c">!     call json_create_object(q,&#39;q&#39;)</span>
    <span class="c">!     call json_add(q,&#39;val&#39;,1)</span>
    <span class="c">!     call json_add(p, q)  !add q to p structure</span>
    <span class="c">!     ! do NOT call json_destroy(q) here, because q is</span>
    <span class="c">!     ! now part of the output structure p.  p should be destroyed</span>
    <span class="c">!     ! somewhere upstream by the caller of this routine.</span>
    <span class="c">!     nullify(q) !OK, but not strictly necessary</span>
    <span class="c">!     end subroutine example2</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_destroy</span>
        <span class="k">module procedure </span><span class="n">json_value_destroy</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Remove a [[json_value]] from a linked-list structure.</span>

    <span class="k">interface </span><span class="n">json_remove</span>
        <span class="k">module procedure </span><span class="n">json_value_remove</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  If the child variable is present, then remove it.</span>

    <span class="k">interface </span><span class="n">json_remove_if_present</span>
        <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_remove_if_present</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a [[json_value]] pointer and make it a double variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!    type(json_value),pointer :: p</span>
    <span class="c">!    call json_create_double(p,&#39;value&#39;,1.0d0)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_double</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_double</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a [[json_value]] pointer and make it an array variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create(p,&#39;arrayname&#39;)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_array</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_array</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a [[json_value]] pointer and make it an object variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create(p,&#39;objectname&#39;)</span>
    <span class="c">!```</span>
    <span class="c">!</span>
    <span class="c">!@note The name is not significant for the root structure or an array element.</span>
    <span class="c">!      In those cases, an empty string can be used.</span>

    <span class="k">interface </span><span class="n">json_create_object</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_object</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a json_value pointer and make it a null variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create_null(p,&#39;value&#39;)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_null</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_null</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a json_value pointer and make it a string variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create_string(p,&#39;value&#39;,&#39;foobar&#39;)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_string</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_string</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a json_value pointer and make it an integer variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create_integer(p,&#39;value&#39;,42)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_integer</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_integer</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Allocate a json_value pointer and make it a logical variable.</span>
    <span class="c">!  The pointer should not already be allocated.</span>
    <span class="c">!</span>
    <span class="c">!# Example</span>
    <span class="c">!</span>
    <span class="c">!```fortran</span>
    <span class="c">!     type(json_value),pointer :: p</span>
    <span class="c">!     call json_create_logical(p,&#39;value&#39;,.true.)</span>
    <span class="c">!```</span>

    <span class="k">interface </span><span class="n">json_create_logical</span>
        <span class="k">module procedure  </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_value_create_logical</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Parse the JSON file and populate the [[json_value]] tree.</span>

    <span class="k">interface </span><span class="n">json_parse</span>
       <span class="k">module procedure  </span><span class="n">json_parse_file</span><span class="p">,</span> <span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_parse_string</span><span class="p">)</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Convert a &#39;DEFAULT&#39; kind character input to &#39;ISO_10646&#39; kind and return it</span>

    <span class="k">interface </span><span class="n">to_unicode</span>
        <span class="k">module procedure </span><span class="n">to_uni</span><span class="p">,</span> <span class="n">to_uni_vec</span>
    <span class="k">end interface</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!*************************************************************************************</span>
    <span class="c">!&gt;</span>
    <span class="c">!  Throw an exception.</span>

    <span class="k">interface </span><span class="n">throw_exception</span>
       <span class="k">module procedure </span><span class="n">MAYBEWRAP</span><span class="p">(</span><span class="n">json_throw_exception</span><span class="p">)</span>
    <span class="k">end interface </span><span class="n">throw_exception</span>
    <span class="c">!*************************************************************************************</span>

    <span class="c">!public routines:</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_add</span>                   <span class="c">! add data to a JSON structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_check_for_errors</span>      <span class="c">! check for error and get error message</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_clear_exceptions</span>      <span class="c">! clear exceptions</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_count</span>                 <span class="c">! count the number of children</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_array</span>          <span class="c">! allocate a json_value array</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_double</span>         <span class="c">! allocate a json_value double</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_integer</span>        <span class="c">! allocate a json_value integer</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_logical</span>        <span class="c">! allocate a json_value logical</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_null</span>           <span class="c">! allocate a json_value null</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_object</span>         <span class="c">! allocate a json_value object</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_create_string</span>         <span class="c">! allocate a json_value string</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_destroy</span>               <span class="c">! clear a JSON structure (destructor)</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_clone</span>                 <span class="c">! clone a JSON structure (deep copy)</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_failed</span>                <span class="c">! check for error</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get</span>                   <span class="c">! get data from the JSON structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get_child</span>             <span class="c">! get a child of a json_value</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get_parent</span>            <span class="c">! get pointer to json_value parent</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get_next</span>              <span class="c">! get pointer to json_value next</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get_previous</span>          <span class="c">! get pointer to json_value previous</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_get_tail</span>              <span class="c">! get pointer to json_value tail</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_info</span>                  <span class="c">! get info about a json_value</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_initialize</span>            <span class="c">! to initialize the module</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_parse</span>                 <span class="c">! read a JSON file and populate the structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_print</span>                 <span class="c">! print the JSON structure to a file</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_print_to_string</span>       <span class="c">! write the JSON structure to a string</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_remove</span>                <span class="c">! remove from a JSON structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_remove_if_present</span>     <span class="c">! remove from a JSON structure (if it is present)</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_update</span>                <span class="c">! update a value in a JSON structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_traverse</span>              <span class="c">! to traverse all elements of a JSON structure</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">json_print_error_message</span>   <span class="c">!</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">to_unicode</span>                 <span class="c">! Function to convert from &#39;DEFAULT&#39; to &#39;ISO_10646&#39; strings</span>

<span class="cp"># ifdef USE_UCS4</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">operator</span><span class="p">(</span><span class="o">//</span><span class="p">)</span>
    <span class="k">public</span> <span class="kd">::</span> <span class="n">operator</span><span class="p">(</span><span class="o">==</span><span class="p">)</span>
<span class="cp"># endif</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span><span class="p">,</span><span class="k">public</span> <span class="kd">::</span> <span class="n">json_ext</span> <span class="o">=</span> <span class="s1">&#39;.json&#39;</span>   <span class="c">!! JSON file extension</span>

    <span class="c">!special JSON characters</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">space</span>           <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">start_object</span>    <span class="o">=</span> <span class="s1">&#39;{&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">end_object</span>      <span class="o">=</span> <span class="s1">&#39;}&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">start_array</span>     <span class="o">=</span> <span class="s1">&#39;[&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">end_array</span>       <span class="o">=</span> <span class="s1">&#39;]&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">delimiter</span>       <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">colon_char</span>      <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">bspace</span>          <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">horizontal_tab</span>  <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">newline</span>         <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">formfeed</span>        <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">carriage_return</span> <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">quotation_mark</span>  <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">slash</span>           <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">47</span><span class="p">)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">backslash</span>       <span class="o">=</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span>

    <span class="c">!These were parameters, but gfortran bug (https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65141)</span>
    <span class="c">!necessitates moving them here to be variables</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">null_str</span>  <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">true_str</span>  <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="kd">::</span> <span class="n">false_str</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>

    <span class="c">! Control characters, possibly in unicode</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">i_</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">control_chars</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">achar</span><span class="p">(</span><span class="n">i_</span><span class="p">),</span><span class="n">i_</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">31</span><span class="p">),</span> <span class="nb">achar</span><span class="p">(</span><span class="mi">127</span><span class="p">)]</span>

    <span class="c">!for indenting (Note: jsonlint.com uses 4 spaces)</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">spaces_per_tab</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c">!Variables for real string printing:</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">compact_real</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>   <span class="c">!! to use the &quot;compact&quot; form of real numbers for output</span>

    <span class="c">!find out the precision of the floating point number system</span>
    <span class="c">!and set safety factors</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">rp_safety_factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">rp_addl_safety</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">real_precision</span> <span class="o">=</span> <span class="n">rp_safety_factor</span><span class="o">*</span><span class="nb">precision</span><span class="p">(</span><span class="mf">1.0_RK</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
                                              <span class="n">rp_addl_safety</span>

    <span class="c">!Get the number of possible digits in the exponent when using decimal number system</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">maxexp</span> <span class="o">=</span> <span class="nb">maxexponent</span><span class="p">(</span><span class="mf">1.0_RK</span><span class="p">)</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">minexp</span> <span class="o">=</span> <span class="nb">minexponent</span><span class="p">(</span><span class="mf">1.0_RK</span><span class="p">)</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">real_exponent_digits</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">log10</span><span class="p">(</span> <span class="p">&amp;</span>
                                  <span class="kt">real</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">maxexp</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">maxexp</span><span class="p">)),&amp;</span>
                                  <span class="nb">kind</span><span class="o">=</span><span class="n">RK</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">max_numeric_str_len</span> <span class="o">=</span> <span class="n">real_precision</span> <span class="o">+</span> <span class="n">real_exponent_digits</span> <span class="o">+</span> <span class="mi">6</span>
    <span class="c">!! 6 = sign + leading 0 + decimal + &#39;E&#39; + exponent sign + 1 extra</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">int_fmt</span>  <span class="o">=</span> <span class="s1">&#39;(ss,I0)&#39;</span> <span class="c">!! minimum width format for integers</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">star</span>     <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="c">!! for invalid numbers and list-directed real output</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">real_fmt</span>  <span class="c">!! the format string to use for real numbers</span>
                                                       <span class="c">!! it is set in [[json_initialize]]</span>

    <span class="c">!</span>
    <span class="c">! Note: the following global variables make this module non thread safe.</span>
    <span class="c">!</span>

    <span class="c">!exception handling [private variables]</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">is_verbose</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>        <span class="c">!! if true, all exceptions are immediately printed to console</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">exception_thrown</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>   <span class="c">!! the error flag (by default, this is true to</span>
                                               <span class="c">!! make sure that [[json_initialize]] is called.</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">err_message</span> <span class="c">!! the error message</span>

    <span class="c">!temp vars used when parsing lines in file [private variables]</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c">!character position in the current line</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">line_count</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c">!lines read counter</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pushed_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pushed_char</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c">!JW : what is this magic number 10??</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c">!! for allocatable strings: allocate chunks of this size</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ipos</span> <span class="o">=</span> <span class="mi">1</span>                    <span class="c">!! for allocatable strings: next character to read</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">unit2str</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c">!! unit number to cause stuff to be</span>
                                            <span class="c">!! output to strings rather than files.</span>
                                            <span class="c">!! See 9.5.6.12 in the F2003/08 standard</span>

    <span class="k">contains</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/31/2015</span>
<span class="c">!</span>
<span class="c">!  Create a deep copy of a [[json_value]] linked-list structure.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!    program test</span>
<span class="c">!     use json_module</span>
<span class="c">!     implicit none</span>
<span class="c">!     type(json_value),pointer :: j1, j2</span>
<span class="c">!     call json_initialize()</span>
<span class="c">!     call json_parse(&#39;../files/inputs/test1.json&#39;,j1)</span>
<span class="c">!     call json_clone(j1,j2) !now have two independent copies</span>
<span class="c">!     call json_destroy(j1)  !destroys j1, but j2 remains</span>
<span class="c">!     call json_print(j2,&#39;j2.json&#39;)</span>
<span class="c">!     call json_destroy(j2)</span>
<span class="c">!    end program test</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_clone</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="n">to</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">from</span>  <span class="c">!! this is the structure to clone</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">to</span>    <span class="c">!! the clone is put here</span>
                                      <span class="c">!! (it must not already be associated)</span>

    <span class="c">!call the main function:</span>
    <span class="k">call </span><span class="n">json_value_clone_func</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="n">to</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_clone</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/31/2015</span>
<span class="c">!</span>
<span class="c">!  Recursive deep copy function called by [[json_clone]].</span>
<span class="c">!</span>
<span class="c">!@note If new data is added to the [[json_value]] type,</span>
<span class="c">!      then this would need to be updated.</span>

    <span class="k">recursive subroutine </span><span class="n">json_value_clone_func</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">previous</span><span class="p">,</span><span class="n">next</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">tail</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">from</span>     <span class="c">!! this is the structure to clone</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">to</span>       <span class="c">!! the clone is put here</span>
                                                  <span class="c">!! (it must not already be associated)</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">parent</span>   <span class="c">!! to%parent</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">previous</span> <span class="c">!! to%previous</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">next</span>     <span class="c">!! to%next</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">children</span> <span class="c">!! to%children</span>
    <span class="kt">logical</span><span class="p">,</span><span class="k">optional</span>                  <span class="kd">::</span> <span class="n">tail</span>     <span class="c">!! if &quot;to&quot; is the tail of its parent&#39;s children</span>

    <span class="k">nullify</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">))</span> <span class="k">then</span>

<span class="k">        allocate</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>

        <span class="c">!copy over the data variables:</span>
        <span class="c">! [note: the allocate() statements don&#39;t work here for the</span>
        <span class="c">!  deferred-length characters in gfortran-4.9]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">name</span><span class="p">))</span>      <span class="n">to</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="n">from</span><span class="p">%</span><span class="n">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span><span class="n">to</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">from</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">log_value</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span><span class="n">to</span><span class="p">%</span><span class="n">log_value</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">from</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">str_value</span><span class="p">))</span> <span class="n">to</span><span class="p">%</span><span class="n">str_value</span> <span class="o">=</span> <span class="n">from</span><span class="p">%</span><span class="n">str_value</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">int_value</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span><span class="n">to</span><span class="p">%</span><span class="n">int_value</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">from</span><span class="p">%</span><span class="n">int_value</span><span class="p">)</span>
        <span class="n">to</span><span class="p">%</span><span class="n">var_type</span>   <span class="o">=</span> <span class="n">from</span><span class="p">%</span><span class="n">var_type</span>
        <span class="n">to</span><span class="p">%</span><span class="n">n_children</span> <span class="o">=</span> <span class="n">from</span><span class="p">%</span><span class="n">n_children</span>

        <span class="c">!allocate and associate the pointers as necessary:</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>      <span class="n">to</span><span class="p">%</span><span class="n">parent</span>      <span class="o">=&gt;</span> <span class="n">parent</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">previous</span><span class="p">))</span>    <span class="n">to</span><span class="p">%</span><span class="n">previous</span>    <span class="o">=&gt;</span> <span class="n">previous</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">next</span><span class="p">))</span>        <span class="n">to</span><span class="p">%</span><span class="n">next</span>        <span class="o">=&gt;</span> <span class="n">next</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">children</span><span class="p">))</span>    <span class="n">to</span><span class="p">%</span><span class="n">children</span>    <span class="o">=&gt;</span> <span class="n">children</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">tail</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="n">to</span><span class="p">%</span><span class="n">parent</span><span class="p">%</span><span class="n">tail</span> <span class="o">=&gt;</span> <span class="n">to</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">next</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">to</span><span class="p">%</span><span class="n">next</span><span class="p">)</span>
            <span class="k">call </span><span class="n">json_value_clone_func</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">next</span><span class="p">,&amp;</span>
                                       <span class="n">to</span><span class="p">%</span><span class="n">next</span><span class="p">,&amp;</span>
                                       <span class="n">previous</span><span class="o">=</span><span class="n">to</span><span class="p">,&amp;</span>
                                       <span class="n">parent</span><span class="o">=</span><span class="n">to</span><span class="p">%</span><span class="n">parent</span><span class="p">,&amp;</span>
                                       <span class="n">tail</span><span class="o">=</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">next</span><span class="p">%</span><span class="n">next</span><span class="p">)))</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">children</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">to</span><span class="p">%</span><span class="n">children</span><span class="p">)</span>
            <span class="k">call </span><span class="n">json_value_clone_func</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">children</span><span class="p">,&amp;</span>
                                       <span class="n">to</span><span class="p">%</span><span class="n">children</span><span class="p">,&amp;</span>
                                       <span class="n">parent</span><span class="o">=</span><span class="n">to</span><span class="p">,&amp;</span>
                                       <span class="n">tail</span><span class="o">=</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">children</span><span class="p">%</span><span class="n">next</span><span class="p">)))</span>
        <span class="k">end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_clone_func</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!  date: 07/23/2015</span>
<span class="c">!</span>
<span class="c">!  Cast a [[json_value]] object as a [[json_file(type)]] object</span>

    <span class="k">function </span><span class="n">initialize_json_file</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">file_object</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">optional</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>  <span class="c">!! `json_value` object to cast</span>
                                                       <span class="c">!! as a `json_file` object</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span> <span class="kd">::</span> <span class="n">file_object</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="n">file_object</span><span class="p">%</span><span class="n">p</span> <span class="o">=&gt;</span> <span class="n">p</span>

    <span class="k">end function </span><span class="n">initialize_json_file</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Destroy the data within a [[json_value]], and rest type to `json_unknown`.</span>

    <span class="k">subroutine </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d</span>

    <span class="n">d</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_unknown</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">log_value</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">int_value</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">int_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">str_value</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">d</span><span class="p">%</span><span class="n">str_value</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">destroy_json_data</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Destroy the [[json_file(type)]].</span>

    <span class="k">subroutine </span><span class="n">json_file_destroy</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">))</span> <span class="k">call </span><span class="n">json_value_destroy</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_destroy</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/5/2014</span>
<span class="c">!</span>
<span class="c">!  Move the [[json_value]] pointer from one [[json_file(type)]] to another.</span>
<span class="c">!  The &quot;from&quot; pointer is then nullified, but not destroyed.</span>
<span class="c">!</span>
<span class="c">!@note If &quot;from%p&quot; is not associated, then an error is thrown.</span>

    <span class="k">subroutine </span><span class="n">json_file_move_pointer</span><span class="p">(</span><span class="n">to</span><span class="p">,</span><span class="n">from</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">to</span>
    <span class="k">class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">from</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">to</span><span class="p">%</span><span class="n">p</span> <span class="o">=&gt;</span> <span class="n">from</span><span class="p">%</span><span class="n">p</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">from</span><span class="p">%</span><span class="n">p</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_file_move_pointer: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39;pointer is not associated.&#39;</span><span class="p">)</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_file_move_pointer</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Load the JSON data from a file.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!     program main</span>
<span class="c">!      use json_module</span>
<span class="c">!      implicit none</span>
<span class="c">!      type(json_file) :: f</span>
<span class="c">!      call json_initialize()</span>
<span class="c">!      call f%load_file(&#39;my_file.json&#39;)</span>
<span class="c">!      !...</span>
<span class="c">!      call f%destroy()</span>
<span class="c">!     end program main</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_file_load</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filename</span>  <span class="c">!! the filename to open</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">unit</span>      <span class="c">!! the unit number to use (if not present, a newunit is used)</span>

    <span class="k">call </span><span class="n">json_parse</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_load</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/13/2015</span>
<span class="c">!</span>
<span class="c">!  Load the JSON data from a string.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!  Load JSON from a string:</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_file) :: f</span>
<span class="c">!     call f%load_from_string(&#39;{ &quot;name&quot;: &quot;Leonidas&quot; }&#39;)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_file_load_from_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>  <span class="c">!! string to load JSON data from</span>

    <span class="k">call </span><span class="n">json_parse</span><span class="p">(</span><span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_load_from_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_load_from_string]], where &quot;str&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_load_from_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>

    <span class="k">call </span><span class="n">json_file_load_from_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_load_from_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/11/2015</span>
<span class="c">!</span>
<span class="c">!  Print the JSON file to the console.</span>

    <span class="k">subroutine </span><span class="n">json_file_print_to_console</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">dummy</span>

    <span class="k">call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">iunit</span><span class="o">=</span><span class="n">output_unit</span><span class="p">,</span><span class="n">str</span><span class="o">=</span><span class="n">dummy</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">colon</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>

    <span class="k">end subroutine </span><span class="n">json_file_print_to_console</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Prints the JSON file to the specified file unit number.</span>

    <span class="k">subroutine </span><span class="n">json_file_print_1</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">iunit</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">iunit</span>  <span class="c">!! file unit number (must not be -1)</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">dummy</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">iunit</span><span class="o">/=</span><span class="n">unit2str</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">i</span> <span class="o">=</span> <span class="n">iunit</span>
        <span class="k">call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">iunit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">str</span><span class="o">=</span><span class="n">dummy</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">colon</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_file_print_1: iunit must not be -1.&#39;</span><span class="p">)</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_file_print_1</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/11/2015</span>
<span class="c">!</span>
<span class="c">!  Print the JSON structure to the specified filename.</span>
<span class="c">!  The file is opened, printed, and then closed.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!  Example loading a JSON file, changing a value, and then printing</span>
<span class="c">!  result to a new file:</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_file) :: f</span>
<span class="c">!     logical :: found</span>
<span class="c">!     call f%load_file(&#39;my_file.json&#39;)    !open the original file</span>
<span class="c">!     call f%update(&#39;version&#39;,4,found)    !change the value of a variable</span>
<span class="c">!     call f%print_file(&#39;my_file_2.json&#39;) !save file as new name</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_file_print_2</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filename</span>  <span class="c">!! filename to print to</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iunit</span><span class="p">,</span><span class="n">istat</span>

    <span class="k">open</span><span class="p">(</span><span class="n">newunit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span> <span class="n">FILE_ENCODING</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">me</span><span class="p">%</span><span class="n">print_file</span><span class="p">(</span><span class="n">iunit</span><span class="p">)</span>    <span class="c">!call the other routine</span>
        <span class="k">close</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_file_print_2: could not open file: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                              <span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_file_print_2</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/11/2015</span>
<span class="c">!</span>
<span class="c">!  Print the JSON file to a string.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!  Open a JSON file, and then print the contents to a string:</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_file) :: f</span>
<span class="c">!     character(kind=CK,len=:),allocatable :: str</span>
<span class="c">!     call f%load_file(&#39;my_file.json&#39;)</span>
<span class="c">!     call f%print_file(str)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_file_print_to_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>  <span class="c">!! string to print JSON data to</span>

    <span class="k">call </span><span class="n">json_value_to_string</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_print_to_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 2/3/2014</span>
<span class="c">!</span>
<span class="c">!  Returns information about a variable in a [[json_file(type)]].</span>

    <span class="k">subroutine </span><span class="n">json_file_variable_info</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">found</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">n_children</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>       <span class="c">!! path to the variable</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>      <span class="c">!! the variable exists in the structure</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">var_type</span>   <span class="c">!! variable type</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">n_children</span> <span class="c">!! number of children</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="c">!initialize:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">!get a pointer to the variable (if it is there):</span>
    <span class="k">call </span><span class="n">me</span><span class="p">%</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!get info:</span>
        <span class="k">call </span><span class="n">json_info</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">n_children</span><span class="p">)</span>

    <span class="k">else</span>

        <span class="c">!set to dummy values:</span>
        <span class="n">var_type</span> <span class="o">=</span> <span class="n">json_unknown</span>
        <span class="n">n_children</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">end if</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_variable_info</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_variable_info]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_variable_info</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">found</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">n_children</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">var_type</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">n_children</span>

    <span class="k">call </span><span class="n">json_file_variable_info</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="n">found</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">n_children</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_variable_info</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 2/13/2014</span>
<span class="c">!</span>
<span class="c">!  Returns information about a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_info</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">n_children</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>         <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">var_type</span>   <span class="c">!! variable type</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">n_children</span> <span class="c">!! number of children</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span> <span class="c">!! variable name</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">var_type</span><span class="p">))</span>    <span class="n">var_type</span>   <span class="o">=</span> <span class="n">p</span><span class="p">%</span><span class="n">var_type</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">n_children</span><span class="p">))</span>  <span class="n">n_children</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>        <span class="n">name</span>       <span class="o">=</span> <span class="n">p</span><span class="p">%</span><span class="n">name</span>

    <span class="k">end subroutine </span><span class="n">json_info</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 2/3/2014</span>
<span class="c">!</span>
<span class="c">!  Get a [[json_value]] pointer to an object from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">path</span>   <span class="c">!! the path to the variable</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>      <span class="c">!! pointer to the variable</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>  <span class="c">!! if it was really found</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!  date: 7/23/2015</span>
<span class="c">!</span>
<span class="c">!  Get a [[json_value]] pointer to the JSON file root.</span>
<span class="c">!</span>
<span class="c">!@note This is equivalent to calling ```[[json_file]]%get(&#39;$&#39;,p)```</span>

    <span class="k">subroutine </span><span class="n">json_file_get_root</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>      <span class="c">!! pointer to the variable</span>

    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">p</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_root</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_object]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Get an integer value from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>   <span class="c">!! the path to the variable</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>  <span class="c">!! if it was really found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_integer]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Get an integer vector from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>   <span class="c">!! the path to the variable</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>    <span class="c">!! the value vector</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>  <span class="c">!! if it was really found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_integer_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_integer_vec]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_integer_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Get a real(RK) variable value from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_double</span> <span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_double]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_double</span> <span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Get a real(RK) vector from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_double_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_double_vec]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_double_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Get a logical(LK) value from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_logical]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Get a logical(LK) vector from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_logical_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_logical_vec]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_logical_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/9/2013</span>
<span class="c">!</span>
<span class="c">!  Get a character string from a json file.</span>
<span class="c">!  The output val is an allocatable character string.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_string]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Get a string vector from a JSON file.</span>

    <span class="k">subroutine </span><span class="n">json_file_get_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                                <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_get_string_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_get_string_vec]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_get_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                                <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_get_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_get_string_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Initialize the JSON-Fortran module.</span>
<span class="c">!  The routine must be called before any of the routines are used.</span>
<span class="c">!  It can also be called after using the module and encountering exceptions.</span>
<span class="c">!</span>
<span class="c">!# Modified</span>
<span class="c">!  * Izaak Beekman : 02/24/2015</span>

    <span class="k">subroutine </span><span class="n">json_initialize</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span><span class="n">compact_reals</span><span class="p">,</span><span class="n">print_signs</span><span class="p">,</span><span class="n">real_format</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">verbose</span>       <span class="c">!! mainly useful for debugging (default is false)</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">compact_reals</span> <span class="c">!! to compact the real number strings for output (default is true)</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">print_signs</span>   <span class="c">!! always print numeric sign (default is false)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">,</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">real_format</span> <span class="c">!! exponential (default), scientific, engineering or general</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="kd">::</span> <span class="n">w</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">sgn</span><span class="p">,</span> <span class="n">rl_edit_desc</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istat</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sgn_prnt</span>

    <span class="c">!clear any errors from previous runs:</span>
    <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>

    <span class="c">!Ensure gfortran bug work around &quot;parameters&quot; are set properly</span>
    <span class="n">null_str</span>  <span class="o">=</span> <span class="s1">&#39;null&#39;</span>
    <span class="n">true_str</span>  <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
    <span class="n">false_str</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>

    <span class="c">!Just in case, clear these global variables also:</span>
    <span class="n">pushed_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pushed_char</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">char_count</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="n">line_count</span>   <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ipos</span>         <span class="o">=</span> <span class="mi">1</span>

<span class="cp"># ifdef USE_UCS4</span>
    <span class="c">! reopen stdout and stderr with utf-8 encoding</span>
    <span class="k">open</span><span class="p">(</span><span class="n">output_unit</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">open</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="cp"># endif</span>

    <span class="c">!verbose error printing:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span> <span class="n">is_verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="c">!Set the format for real numbers:</span>
    <span class="c">! [if not changing it, then it remains the same]</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">allocated</span><span class="p">(</span><span class="n">real_fmt</span><span class="p">))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">&amp;</span>  <span class="c">! if this hasn&#39;t been done yet</span>
          <span class="nb">present</span><span class="p">(</span><span class="n">compact_reals</span><span class="p">)</span>     <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">&amp;</span>
          <span class="nb">present</span><span class="p">(</span><span class="n">print_signs</span><span class="p">)</span>       <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">&amp;</span>
          <span class="nb">present</span><span class="p">(</span><span class="n">real_format</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>

        <span class="c">!allow the special case where real format is &#39;*&#39;:</span>
        <span class="c">! [this overrides the other options]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">real_format</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">real_format</span><span class="o">==</span><span class="n">star</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">compact_real</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                <span class="n">real_fmt</span> <span class="o">=</span> <span class="n">star</span>
                <span class="k">return</span>
<span class="k">            end if</span>
<span class="k">        end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">compact_reals</span><span class="p">))</span> <span class="n">compact_real</span> <span class="o">=</span> <span class="n">compact_reals</span>

        <span class="c">!set defaults</span>
        <span class="n">sgn_prnt</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span> <span class="n">print_signs</span><span class="p">)</span> <span class="p">)</span> <span class="n">sgn_prnt</span> <span class="o">=</span> <span class="n">print_signs</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">sgn_prnt</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           </span><span class="n">sgn</span> <span class="o">=</span> <span class="s1">&#39;sp&#39;</span>
        <span class="k">else</span>
<span class="k">           </span><span class="n">sgn</span> <span class="o">=</span> <span class="s1">&#39;ss&#39;</span>
        <span class="k">end if</span>

<span class="k">        </span><span class="n">rl_edit_desc</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span> <span class="n">real_format</span> <span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           select case</span> <span class="p">(</span> <span class="n">real_format</span> <span class="p">)</span>
           <span class="k">case</span> <span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;en&#39;</span><span class="p">,</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span><span class="s1">&#39;es&#39;</span><span class="p">,</span><span class="s1">&#39;ES&#39;</span><span class="p">)</span>
              <span class="n">rl_edit_desc</span> <span class="o">=</span> <span class="n">real_format</span>
           <span class="k">case </span><span class="n">default</span>
              <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Invalid real format, &quot;&#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">real_format</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;&quot;, passed to json_initialize.&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                   <span class="nb">new_line</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;Acceptable formats are: &quot;G&quot;, &quot;E&quot;, &quot;EN&quot;, and &quot;ES&quot;.&#39;</span> <span class="p">)</span>
           <span class="k">end select</span>
<span class="k">        end if</span>

        <span class="c">! set the default output/input format for reals:</span>
                      <span class="k">write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="s1">&#39;(ss,I0)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">max_numeric_str_len</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">write</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;(ss,I0)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">real_precision</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">write</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;(ss,I0)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">real_exponent_digits</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">real_fmt</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">//</span> <span class="n">sgn</span> <span class="o">//</span> <span class="s1">&#39;,&#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">rl_edit_desc</span><span class="p">)</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;.&#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;E&#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">real_fmt</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">//</span> <span class="n">sgn</span> <span class="o">//</span> <span class="s1">&#39;,&#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">rl_edit_desc</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;30.16E3)&#39;</span>  <span class="c">!just use this one (should never happen)</span>
        <span class="k">end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">json_initialize</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Clear exceptions in the JSON module.</span>

    <span class="k">subroutine </span><span class="n">json_clear_exceptions</span><span class="p">()</span>

    <span class="k">implicit none</span>

    <span class="c">!clear the flag and message:</span>
    <span class="n">exception_thrown</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="n">err_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">end subroutine </span><span class="n">json_clear_exceptions</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Throw an exception in the JSON module.</span>
<span class="c">!  This routine sets the error flag, and prevents any subsequent routine</span>
<span class="c">!  from doing anything, until [[json_clear_exceptions]] is called.</span>

    <span class="k">subroutine </span><span class="n">json_throw_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">msg</span>    <span class="c">!the error message</span>

    <span class="n">exception_thrown</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="n">err_message</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_verbose</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="s1">&#39;***********************&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="s1">&#39;JSON-Fortran EXCEPTION: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c">!call backtrace()     ! gfortran (use -fbacktrace -fall-intrinsics flags)</span>
        <span class="c">!call tracebackqq(-1) ! intel (requires &quot;use ifcore&quot; in this routine)</span>
        <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="s1">&#39;***********************&#39;</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_throw_exception</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_throw_exception]], where &quot;msg&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_throw_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">msg</span>    <span class="c">!the error message</span>

    <span class="k">call </span><span class="n">json_throw_exception</span><span class="p">(</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_throw_exception</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Retrieve error code from the module.</span>
<span class="c">!  This should be called after [[json_parse]] to check for errors.</span>
<span class="c">!  If an error is thrown, before using the module again, [[json_initialize]]</span>
<span class="c">!  should be called to clean up before it is used again.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_file) :: json</span>
<span class="c">!     logical :: status_ok</span>
<span class="c">!     character(kind=CK,len=:),allocatable :: error_msg</span>
<span class="c">!     call json%load_file(filename=&#39;myfile.json&#39;)</span>
<span class="c">!     call json_check_for_errors(status_ok, error_msg)</span>
<span class="c">!     if (.not. status_ok) then</span>
<span class="c">!         write(*,*) &#39;Error: &#39;//error_msg</span>
<span class="c">!         call json_clear_exceptions()</span>
<span class="c">!         call json%destroy()</span>
<span class="c">!     end if</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_failed]]</span>

    <span class="k">subroutine </span><span class="n">json_check_for_errors</span><span class="p">(</span><span class="n">status_ok</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status_ok</span> <span class="c">!! true if there were no errors</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">error_msg</span> <span class="c">!! the error message (if there were errors)</span>

    <span class="n">status_ok</span> <span class="o">=</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">status_ok</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">err_message</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">err_message</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;Error: json_initialize() must be called first to initialize the module.&#39;</span>
        <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">        </span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_check_for_errors</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/5/2013</span>
<span class="c">!</span>
<span class="c">!  Logical function to indicate if an exception has been thrown.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!    type(json_file) :: json</span>
<span class="c">!    logical :: status_ok</span>
<span class="c">!    character(len=:),allocatable :: error_msg</span>
<span class="c">!    call json%load_file(filename=&#39;myfile.json&#39;)</span>
<span class="c">!    if (json_failed()) then</span>
<span class="c">!        call json_check_for_errors(status_ok, error_msg)</span>
<span class="c">!        write(*,*) &#39;Error: &#39;//error_msg</span>
<span class="c">!        call json_clear_exceptions()</span>
<span class="c">!        call json%destroy()</span>
<span class="c">!    end if</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_check_for_errors]]</span>
<span class="c">!</span>
    <span class="k">function </span><span class="n">json_failed</span><span class="p">()</span> <span class="k">result</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">failed</span>

    <span class="n">failed</span> <span class="o">=</span> <span class="n">exception_thrown</span>

    <span class="k">end function </span><span class="n">json_failed</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Allocate a [[json_value]] pointer variable.</span>
<span class="c">!  This should be called before adding data to it.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!    type(json_value),pointer :: var</span>
<span class="c">!    call json_value_create(var)</span>
<span class="c">!    call to_double(var,1.0d0)</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# Notes</span>
<span class="c">!  1. This routine does not check for exceptions.</span>
<span class="c">!  2. The pointer should not already be allocated.</span>

    <span class="k">subroutine </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/22/2014</span>
<span class="c">!</span>
<span class="c">!  Destroy a [[json_value]] linked-list structure.</span>
<span class="c">!</span>
<span class="c">!@note The original FSON version of this</span>
<span class="c">!      routine was not properly freeing the memory.</span>
<span class="c">!      It was rewritten.</span>

    <span class="k">recursive subroutine </span><span class="n">json_value_destroy</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">destroy_next</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">destroy_next</span>  <span class="c">!! if true, then me%next is also destroyed (default is true)</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">des_next</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">))</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">destroy_next</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">des_next</span> <span class="o">=</span> <span class="n">destroy_next</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">des_next</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">)</span>

        <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">children</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            do while</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">n_children</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>
                <span class="n">me</span><span class="p">%</span><span class="n">children</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span><span class="p">%</span><span class="n">next</span>
                <span class="n">me</span><span class="p">%</span><span class="n">n_children</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">n_children</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">call </span><span class="n">json_value_destroy</span><span class="p">(</span><span class="n">p</span><span class="p">,.</span><span class="n">false</span><span class="p">.)</span>
            <span class="k">end do</span>
<span class="k">            nullify</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">children</span><span class="p">)</span>
            <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">next</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">des_next</span><span class="p">)</span> <span class="k">call </span><span class="n">json_value_destroy</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">next</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">previous</span><span class="p">))</span> <span class="k">nullify</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">previous</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">parent</span><span class="p">))</span>   <span class="k">nullify</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">tail</span><span class="p">))</span>     <span class="k">nullify</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">tail</span><span class="p">)</span>

        <span class="k">deallocate</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

        <span class="k">nullify</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_destroy</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 9/9/2014</span>
<span class="c">!</span>
<span class="c">!  Remove a [[json_value]] (and all its children)</span>
<span class="c">!  from a linked-list structure, preserving the rest of the structure.</span>
<span class="c">!</span>
<span class="c">!# Examples</span>
<span class="c">!</span>
<span class="c">!  To extract an object from one JSON structure, and add it to another:</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: json1,json2,p</span>
<span class="c">!     logical :: found</span>
<span class="c">!     !create and populate json1 and json2</span>
<span class="c">!     call json_get(json1,&#39;name&#39;,p,found)  ! get pointer to name element of json1</span>
<span class="c">!     call json_remove(p,destroy=.false.)  ! remove it from json1 (don&#39;t destroy)</span>
<span class="c">!     call json_add(json2,p)               ! add it to json2</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!  To remove an object from a JSON structure (and destroy it):</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: json1,p</span>
<span class="c">!     logical :: found</span>
<span class="c">!     !create and populate json1</span>
<span class="c">!     call json_get(json1,&#39;name&#39;,p,found)  ! get pointer to name element of json1</span>
<span class="c">!     call json_remove(p)                  ! remove and destroy it</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams : 12/28/2014 : added destroy optional argument.</span>
<span class="c">!</span>

    <span class="k">subroutine </span><span class="n">json_value_remove</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">destroy</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>        <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">destroy</span>  <span class="c">!! If destroy is not present, it is also destroyed.</span>
                                                <span class="c">!! If destroy is present and true, it is destroyed.</span>
                                                <span class="c">!! If destroy is present and false, it is not destroyed.</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">parent</span><span class="p">,</span><span class="n">previous</span><span class="p">,</span><span class="n">next</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">destroy_it</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">))</span> <span class="k">then</span>

        <span class="c">!optional input argument:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">destroy</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">destroy_it</span> <span class="o">=</span> <span class="n">destroy</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">destroy_it</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">parent</span><span class="p">))</span> <span class="k">then</span>

<span class="k">            </span><span class="n">parent</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">parent</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">next</span><span class="p">))</span> <span class="k">then</span>

                <span class="c">!there are later items in the list:</span>

                <span class="n">next</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">next</span>
                <span class="k">nullify</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">next</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">previous</span><span class="p">))</span> <span class="k">then</span>
                    <span class="c">!there are earlier items in the list</span>
                    <span class="n">previous</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">previous</span>
                    <span class="n">previous</span><span class="p">%</span><span class="n">next</span> <span class="o">=&gt;</span> <span class="n">next</span>
                    <span class="n">next</span><span class="p">%</span><span class="n">previous</span> <span class="o">=&gt;</span> <span class="n">previous</span>
                <span class="k">else</span>
                    <span class="c">!this is the first item in the list</span>
                    <span class="n">parent</span><span class="p">%</span><span class="n">children</span> <span class="o">=&gt;</span> <span class="n">next</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">next</span><span class="p">%</span><span class="n">previous</span><span class="p">)</span>
                <span class="k">end if</span>

<span class="k">            else</span>

<span class="k">                if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">previous</span><span class="p">))</span> <span class="k">then</span>
                    <span class="c">!there are earlier items in the list:</span>
                    <span class="n">previous</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">previous</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">previous</span><span class="p">%</span><span class="n">next</span><span class="p">)</span>
                    <span class="n">parent</span><span class="p">%</span><span class="n">tail</span> <span class="o">=&gt;</span> <span class="n">previous</span>
                <span class="k">else</span>
                    <span class="c">!this is the only item in the list:</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">parent</span><span class="p">%</span><span class="n">children</span><span class="p">)</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">parent</span><span class="p">%</span><span class="n">tail</span><span class="p">)</span>
                <span class="k">end if</span>

<span class="k">            end if</span>

<span class="k">            </span><span class="n">parent</span><span class="p">%</span><span class="n">n_children</span> <span class="o">=</span> <span class="n">parent</span><span class="p">%</span><span class="n">n_children</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">destroy_it</span><span class="p">)</span> <span class="k">call </span><span class="n">json_value_destroy</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_remove</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/6/2014</span>
<span class="c">!</span>
<span class="c">!  Given the path string, remove the variable from</span>
<span class="c">!  the [[json_value]] structure, if it exists.</span>

    <span class="k">subroutine </span><span class="n">json_value_remove_if_present</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p_var</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">call </span><span class="n">json_remove</span><span class="p">(</span><span class="n">p_var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_remove_if_present</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_remove_if_present]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_remove_if_present</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_remove_if_present</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_remove_if_present</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date:1/10/2015</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present in the file,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_update_integer]]</span>

    <span class="k">subroutine </span><span class="n">json_file_update_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">json_update</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_integer]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_update_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_update_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/10/2015</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present in the file,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_update_logical]]</span>

    <span class="k">subroutine </span><span class="n">json_file_update_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">json_update</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_logical]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_update_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_update_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/10/2015</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present in the file,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_update_double]]</span>

    <span class="k">subroutine </span><span class="n">json_file_update_real</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">json_update</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_real</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_real]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_update_real</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_real</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_update_real</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/10/2015</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present in the file,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_update_string]]</span>

    <span class="k">subroutine </span><span class="n">json_file_update_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">json_update</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_string]], where &quot;name&quot; and &quot;val&quot; are kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_file_update_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_file_update_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_string]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_file_update_string_name_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_string_name_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_file_update_string]], where &quot;val&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_file_update_string_val_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">json_file</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_file_update_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_file_update_string_val_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/6/2014</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>

    <span class="k">subroutine </span><span class="n">json_update_logical</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p_var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">var_type</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">json_info</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">select case</span> <span class="p">(</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">json_null</span><span class="p">,</span><span class="n">json_logical</span><span class="p">,</span><span class="n">json_integer</span><span class="p">,</span><span class="n">json_double</span><span class="p">,</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">call </span><span class="n">to_logical</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>    <span class="c">!update the value</span>
        <span class="k">case </span><span class="n">default</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_update_logical: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;the variable is not a scalar value&#39;</span><span class="p">)</span>
        <span class="k">end select</span>

<span class="k">    else</span>
<span class="k">        call </span><span class="n">json_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>   <span class="c">!add the new element</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_update_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_logical]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_update_logical</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_logical</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_update_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/6/2014</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>

    <span class="k">subroutine </span><span class="n">json_update_double</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p_var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">var_type</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">json_info</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">select case</span> <span class="p">(</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">json_null</span><span class="p">,</span><span class="n">json_logical</span><span class="p">,</span><span class="n">json_integer</span><span class="p">,</span><span class="n">json_double</span><span class="p">,</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">call </span><span class="n">to_double</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>    <span class="c">!update the value</span>
        <span class="k">case </span><span class="n">default</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_update_double: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;the variable is not a scalar value&#39;</span><span class="p">)</span>
        <span class="k">end select</span>

<span class="k">    else</span>
<span class="k">        call </span><span class="n">json_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>   <span class="c">!add the new element</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_update_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_double]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_update_double</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_double</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_update_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/6/2014</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>

    <span class="k">subroutine </span><span class="n">json_update_integer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p_var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">var_type</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">json_info</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">select case</span> <span class="p">(</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">json_null</span><span class="p">,</span><span class="n">json_logical</span><span class="p">,</span><span class="n">json_integer</span><span class="p">,</span><span class="n">json_double</span><span class="p">,</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">call </span><span class="n">to_integer</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>    <span class="c">!update the value</span>
        <span class="k">case </span><span class="n">default</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_update_integer: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;the variable is not a scalar value&#39;</span><span class="p">)</span>
        <span class="k">end select</span>

<span class="k">    else</span>
<span class="k">        call </span><span class="n">json_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>   <span class="c">!add the new element</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_update_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_integer]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_update_integer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_integer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_update_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/6/2014</span>
<span class="c">!</span>
<span class="c">!  Given the path string, if the variable is present,</span>
<span class="c">!  and is a scalar, then update its value.</span>
<span class="c">!  If it is not present, then create it and set its value.</span>

    <span class="k">subroutine </span><span class="n">json_update_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p_var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">var_type</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">json_info</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">select case</span> <span class="p">(</span><span class="n">var_type</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">json_null</span><span class="p">,</span><span class="n">json_logical</span><span class="p">,</span><span class="n">json_integer</span><span class="p">,</span><span class="n">json_double</span><span class="p">,</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">call </span><span class="n">to_string</span><span class="p">(</span><span class="n">p_var</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>    <span class="c">!update the value</span>
        <span class="k">case </span><span class="n">default</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_update_string: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;the variable is not a scalar value&#39;</span><span class="p">)</span>
        <span class="k">end select</span>

<span class="k">    else</span>
<span class="k">        call </span><span class="n">json_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>   <span class="c">!add the new element</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_update_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_string]], where &quot;name&quot; and &quot;value&quot; are kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_update_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_update_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_string]], where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_update_string_name_ascii</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_update_string_name_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_update_string]], where &quot;val&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_update_string_val_ascii</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_update_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_update_string_val_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Adds &quot;member&quot; as a child of &quot;me&quot;.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_member</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">member</span>  <span class="c">!! the child member to add</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">! associate the parent</span>
        <span class="n">member</span><span class="p">%</span><span class="n">parent</span> <span class="o">=&gt;</span> <span class="n">me</span>

        <span class="c">! add to linked list</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">children</span><span class="p">))</span> <span class="k">then</span>

<span class="k">            </span><span class="n">me</span><span class="p">%</span><span class="n">tail</span><span class="p">%</span><span class="n">next</span> <span class="o">=&gt;</span> <span class="n">member</span>
            <span class="n">member</span><span class="p">%</span><span class="n">previous</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">tail</span>

        <span class="k">else</span>

<span class="k">            </span><span class="n">me</span><span class="p">%</span><span class="n">children</span> <span class="o">=&gt;</span> <span class="n">member</span>
            <span class="n">member</span><span class="p">%</span><span class="n">previous</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>  <span class="c">!first in the list</span>

        <span class="k">end if</span>

        <span class="c">! new member is now the last one in the list</span>
        <span class="n">me</span><span class="p">%</span><span class="n">tail</span> <span class="o">=&gt;</span> <span class="n">member</span>
        <span class="n">me</span><span class="p">%</span><span class="n">n_children</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">n_children</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_add_member</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Add a real value child to the [[json_value]] variable</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! variable name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! real value</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>

    <span class="c">!create the variable:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_double</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_double]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! variable name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! real value</span>

    <span class="k">call </span><span class="n">json_value_add_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Add a real vector to the structure.</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">val</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>

    <span class="c">!create the variable as an array:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!populate the array:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">end do</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_double_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_double_vec]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_add_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_double_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Add an integer value child to the [[json_value]] variable</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>

    <span class="c">!create the variable:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_integer</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_integer]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Add an integer vector to the structure.</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>    <span class="c">!counter</span>

    <span class="c">!create the variable as an array:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!populate the array:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">end do</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_integer_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_integer_vec]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_integer_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Add a logical value child to the [[json_value]] variable</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>

    <span class="c">!create the variable:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_logical</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_logical]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Add a logical vector to the structure.</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! name of the vector</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! value</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>    <span class="c">!counter</span>

    <span class="c">!create the variable as an array:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!populate the array:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">end do</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_logical_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_logical_vec]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_logical_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Add a character string child to the [[json_value]] variable.</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! name of the variable</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! value</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">str</span>

    <span class="c">!add escape characters if necessary:</span>
    <span class="k">call </span><span class="n">escape_string</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

    <span class="c">!create the variable:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_string</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string]] where &quot;name&quot; and &quot;val&quot; are kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string_name_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string_name_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string]] where &quot;val&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string_val_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>   <span class="c">!! name of the variable</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>    <span class="c">!! value</span>

    <span class="k">call </span><span class="n">json_value_add_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string_val_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/21/2014</span>
<span class="c">!</span>
<span class="c">!  Add the escape characters to a string for adding to JSON.</span>

    <span class="k">subroutine </span><span class="n">escape_string</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span> <span class="n">str_out</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">str_in</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str_out</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">ipos</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">specials</span> <span class="o">=</span> <span class="n">quotation_mark</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">backslash</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">slash</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">bspace</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">formfeed</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">newline</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">carriage_return</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">horizontal_tab</span>

    <span class="c">!Do a quick scan for the special characters,</span>
    <span class="c">! if any are present, then process the string,</span>
    <span class="c">! otherwise, return the string as is.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">scan</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span><span class="n">specials</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">str_out</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="n">ipos</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c">!go through the string and look for special characters:</span>
        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">str_in</span><span class="p">)</span>

            <span class="n">c</span> <span class="o">=</span> <span class="n">str_in</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span>    <span class="c">!get next character in the input string</span>

            <span class="c">!if the string is not big enough, then add another chunk:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipos</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">str_out</span><span class="p">))</span> <span class="n">str_out</span> <span class="o">=</span> <span class="n">str_out</span> <span class="o">//</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>

            <span class="k">select case</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">case</span><span class="p">(</span><span class="n">quotation_mark</span><span class="p">,</span><span class="n">backslash</span><span class="p">,</span><span class="n">slash</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">backslash</span><span class="o">//</span><span class="n">c</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case</span><span class="p">(</span><span class="n">bspace</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\b&#39;</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case</span><span class="p">(</span><span class="n">formfeed</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\f&#39;</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\n&#39;</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case</span><span class="p">(</span><span class="n">carriage_return</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\r&#39;</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case</span><span class="p">(</span><span class="n">horizontal_tab</span><span class="p">)</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\t&#39;</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">case </span><span class="n">default</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">end select</span>

<span class="k">        end do</span>

        <span class="c">!trim the string if necessary:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ipos</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">str_out</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">ipos</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">str_out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="n">str_out</span> <span class="o">=</span> <span class="n">str_out</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ipos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">end if</span>
<span class="k">        end if</span>

<span class="k">    else</span>

<span class="k">        </span><span class="n">str_out</span> <span class="o">=</span> <span class="n">str_in</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">escape_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Add an array of character strings to the structure.</span>
<span class="c">!</span>
<span class="c">!@note This routine is part of the public API that can be</span>
<span class="c">!      used to build a JSON structure using [[json_value]] pointers.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                         <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">name</span>        <span class="c">!! variable name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>         <span class="c">!! array of strings</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                  <span class="kd">::</span> <span class="n">trim_str</span>    <span class="c">!! if TRIM() should be called for each element</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                  <span class="kd">::</span> <span class="n">adjustl_str</span> <span class="c">!! if ADJUSTL() should be called for each element</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">var</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">trim_string</span><span class="p">,</span> <span class="n">adjustl_string</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">str</span>

    <span class="c">!if the string is to be trimmed or not:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">trim_str</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">trim_string</span> <span class="o">=</span> <span class="n">trim_str</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">trim_string</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="k">end if</span>
<span class="k">    if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">adjustl_str</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">adjustl_string</span> <span class="o">=</span> <span class="n">adjustl_str</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">adjustl_string</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="k">end if</span>

    <span class="c">!create the variable as an array:</span>
    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="c">!populate the array:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c">!the string to write:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">val</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adjustl_string</span><span class="p">)</span> <span class="n">str</span> <span class="o">=</span> <span class="nb">adjustl</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trim_string</span><span class="p">)</span>    <span class="n">str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

        <span class="c">!write it:</span>
        <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

        <span class="c">!cleanup</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

    <span class="k">end do</span>

    <span class="c">!add it:</span>
    <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

    <span class="c">!cleanup:</span>
    <span class="k">nullify</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string_vec]] where &quot;name&quot; and &quot;val&quot; are kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_add_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                          <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">trim_str</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">adjustl_str</span>

    <span class="k">call </span><span class="n">json_value_add_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_add_string_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string_vec]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string_vec_name_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                          <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">trim_str</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">adjustl_str</span>

    <span class="k">call </span><span class="n">json_value_add_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string_vec_name_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_add_string_vec]] where &quot;val&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">json_value_add_string_vec_val_ascii</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                          <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">trim_str</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                   <span class="kd">::</span> <span class="n">adjustl_str</span>

    <span class="k">call </span><span class="n">json_value_add_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">trim_str</span><span class="p">,</span> <span class="n">adjustl_str</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_add_string_vec_val_ascii</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Count the number of children.</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * JW : 1/4/2014 : Original routine removed.</span>
<span class="c">!    Now using n_children variable.</span>
<span class="c">!    Renamed from json_value_count.</span>

    <span class="k">pure function </span><span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="nb">count</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span>                         <span class="kd">::</span> <span class="nb">count</span>  <span class="c">!! number of children</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>

    <span class="nb">count</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">n_children</span>

    <span class="k">end function </span><span class="n">json_count</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/16/2015</span>
<span class="c">!</span>
<span class="c">!  Returns a pointer to the parent of a [[json_value]].</span>
<span class="c">!  If there is no parent, then a null() pointer is returned.</span>

    <span class="k">subroutine </span><span class="n">json_get_parent</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>   <span class="c">!! JSON object</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>   <span class="c">!! pointer to parent</span>

    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">parent</span>

    <span class="k">end subroutine </span><span class="n">json_get_parent</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/31/2015</span>
<span class="c">!</span>
<span class="c">!  Returns a pointer to the next of a [[json_value]].</span>
<span class="c">!  If there is no next, then a null() pointer is returned.</span>

    <span class="k">subroutine </span><span class="n">json_get_next</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>   <span class="c">!! JSON object</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>    <span class="c">!! pointer to next</span>

    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">next</span>

    <span class="k">end subroutine </span><span class="n">json_get_next</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/31/2015</span>
<span class="c">!</span>
<span class="c">!  Returns a pointer to the previous of a [[json_value]].</span>
<span class="c">!  If there is no previous, then a null() pointer is returned.</span>

    <span class="k">subroutine </span><span class="n">json_get_previous</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>   <span class="c">!! JSON object</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>    <span class="c">!! pointer to previous</span>

    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">previous</span>

    <span class="k">end subroutine </span><span class="n">json_get_previous</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 10/31/2015</span>
<span class="c">!</span>
<span class="c">!  Returns a pointer to the tail of a [[json_value]].</span>
<span class="c">!  If there is no tail, then a null() pointer is returned.</span>

    <span class="k">subroutine </span><span class="n">json_get_tail</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>    <span class="c">!! JSON object</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>    <span class="c">!! pointer to tail</span>

    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">tail</span>

    <span class="k">end subroutine </span><span class="n">json_get_tail</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Returns a child in the object or array given the index.</span>

    <span class="k">subroutine </span><span class="n">json_value_get_by_index</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>   <span class="c">!! object or array JSON data</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">idx</span>  <span class="c">!! index of the child</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>    <span class="c">!! pointer to the child</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>

    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">children</span><span class="p">))</span> <span class="k">then</span>

<span class="k">            </span><span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>

            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">%</span><span class="n">next</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                    </span><span class="n">p</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">%</span><span class="n">next</span>
                <span class="k">else</span>
<span class="k">                    call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_get_by_index:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                         <span class="s1">&#39; p%next is not associated.&#39;</span><span class="p">)</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">return</span>
<span class="k">                end if</span>

<span class="k">            end do</span>

<span class="k">        else</span>

<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_get_by_index:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; me%children is not associated.&#39;</span><span class="p">)</span>

        <span class="k">end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_get_by_index</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Returns a child in the object or array given the name string.</span>
<span class="c">!</span>
<span class="c">!  It is a case-sensitive search, and the name string is not trimmed.</span>
<span class="c">!  So, for example,</span>
<span class="c">!```fortran</span>
<span class="c">!     &#39;a &#39; /= &#39;A &#39; /= &#39;a  &#39;</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!@note The &quot;name&quot; input is not a path, and is not parsed like it is in [[json_get_by_path]].</span>

    <span class="k">subroutine </span><span class="n">json_value_get_by_name_chars</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! the name of a child of &quot;me&quot;</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>     <span class="c">!! pointer to the child</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">n_children</span>

    <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">me</span><span class="p">))</span> <span class="k">then</span>

<span class="k">            if</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="o">==</span><span class="n">json_object</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">n_children</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>    <span class="c">!start with first one</span>
                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_children</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">p</span><span class="p">%</span><span class="n">name</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                        if</span> <span class="p">(</span><span class="n">p</span><span class="p">%</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="k">return</span>
<span class="k">                    end if</span>
<span class="k">                    </span><span class="n">p</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">%</span><span class="n">next</span>
                <span class="k">end do</span>
<span class="k">            end if</span>

            <span class="c">!did not find anything:</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_get_by_name_chars: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;child variable &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; was not found.&#39;</span><span class="p">)</span>
            <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">else</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_get_by_name_chars: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;pointer is not associated.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">json_value_get_by_name_chars</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_value_get_by_name_chars]] where &quot;name&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_get_by_name_chars</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>

    <span class="k">call </span><span class="n">json_value_get_by_name_chars</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_get_by_name_chars</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 2/12/2014</span>
<span class="c">!</span>
<span class="c">!  Print the [[json_value]] structure to an allocatable string.</span>

    <span class="k">subroutine </span><span class="n">json_value_to_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">str</span>  <span class="c">!! prints structure to this string</span>

    <span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">iunit</span><span class="o">=</span><span class="n">unit2str</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colon</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>

    <span class="k">end subroutine </span><span class="n">json_value_to_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 6/20/2014</span>
<span class="c">!</span>
<span class="c">!  Print the [[json_value]] structure to a file.</span>

    <span class="k">subroutine </span><span class="n">json_print_1</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">iunit</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">iunit</span>   <span class="c">!! the file unit (the file must already have been opened, can&#39;t be -1).</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">dummy</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">iunit</span><span class="o">/=</span><span class="n">unit2str</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">iunit</span><span class="p">,</span><span class="n">str</span><span class="o">=</span><span class="n">dummy</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colon</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_print: iunit must not be -1.&#39;</span><span class="p">)</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_print_1</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/23/2014</span>
<span class="c">!</span>
<span class="c">!  Print the [[json_value]] structure to a file.</span>

    <span class="k">subroutine </span><span class="n">json_print_2</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filename</span>  <span class="c">!! the filename to print to (should not already be open)</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iunit</span><span class="p">,</span><span class="n">istat</span>

    <span class="k">open</span><span class="p">(</span><span class="n">newunit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span> <span class="n">FILE_ENCODING</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">json_print</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">iunit</span><span class="p">)</span>
        <span class="k">close</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_print: could not open file: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                              <span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_print_2</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Print the JSON structure to a string or a file.</span>
<span class="c">!</span>
<span class="c">!# Notes</span>
<span class="c">!  * This is an internal routine called by the wrapper routines</span>
<span class="c">!    [[json_print]] and [[json_value_to_string]].</span>
<span class="c">!  * The reason the str argument is non-optional is because of a</span>
<span class="c">!    bug in v4.9 of the gfortran compiler.</span>

    <span class="k">recursive subroutine </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">iunit</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">need_comma</span><span class="p">,</span><span class="n">colon</span><span class="p">,</span><span class="n">is_array_element</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">iunit</span>             <span class="c">!! file unit to write to (6=console)</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">indent</span>            <span class="c">!! indention level</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">is_array_element</span>  <span class="c">!! if this is an array element</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">need_comma</span>        <span class="c">!! if it needs a comma after it</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">colon</span>             <span class="c">!! if the colon was just written</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">str</span>
                                                      <span class="c">!! if iunit==unit2str (-1) then the structure is</span>
                                                      <span class="c">!! printed to this string rather than</span>
                                                      <span class="c">!! a file. This mode is used by</span>
                                                      <span class="c">!! [[json_value_to_string]].</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">max_numeric_str_len</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmp</span> <span class="c">!for val to string conversions</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">s</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">element</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tab</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">,</span> <span class="n">spaces</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">print_comma</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">write_file</span><span class="p">,</span> <span class="n">write_string</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">is_array</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!whether to write a string or a file (one or the other):</span>
        <span class="n">write_string</span> <span class="o">=</span> <span class="p">(</span><span class="n">iunit</span><span class="o">==</span><span class="n">unit2str</span><span class="p">)</span>
        <span class="n">write_file</span> <span class="o">=</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">write_string</span>

        <span class="c">!if the comma will be printed after the value</span>
        <span class="c">! [comma not printed for the last elements]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">need_comma</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">print_comma</span> <span class="o">=</span> <span class="n">need_comma</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">print_comma</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!number of &quot;tabs&quot; to indent:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">indent</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">tab</span> <span class="o">=</span> <span class="n">indent</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">tab</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">end if</span>
        <span class="c">!convert to number of spaces:</span>
        <span class="n">spaces</span> <span class="o">=</span> <span class="n">tab</span><span class="o">*</span><span class="n">spaces_per_tab</span>

        <span class="c">!if this is an element in an array:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">is_array_element</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">is_array</span> <span class="o">=</span> <span class="n">is_array_element</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">is_array</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!if the colon was the last thing written</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">colon</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">s</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">spaces</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        select case</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>

        <span class="k">case</span> <span class="p">(</span><span class="n">json_object</span><span class="p">)</span>

            <span class="nb">count</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!special case for empty object</span>

                <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">start_object</span><span class="o">//</span><span class="n">end_object</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>

            <span class="k">else</span>

<span class="k">                call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">start_object</span> <span class="p">)</span>

                <span class="c">!if an object is in an array, there is an extra tab:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_array</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                     </span><span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="o">+</span><span class="mi">1</span>
                     <span class="n">spaces</span> <span class="o">=</span> <span class="n">tab</span><span class="o">*</span><span class="n">spaces_per_tab</span>
                <span class="k">end if</span>

<span class="k">                nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>
                <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">count</span>

                    <span class="c">! print the name</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">element</span><span class="p">%</span><span class="n">name</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                        call </span><span class="n">write_it</span><span class="p">(</span><span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">spaces</span><span class="p">)</span><span class="o">//</span><span class="n">quotation_mark</span><span class="o">//</span><span class="p">&amp;</span>
                                      <span class="n">element</span><span class="p">%</span><span class="n">name</span><span class="o">//</span><span class="n">quotation_mark</span><span class="o">//</span><span class="n">colon_char</span><span class="o">//</span><span class="n">space</span><span class="p">,&amp;</span>
                                      <span class="n">advance</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
                    <span class="k">else</span>
<span class="k">                        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_print:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                             <span class="s1">&#39; element%name not allocated&#39;</span><span class="p">)</span>
                        <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                        <span class="k">return</span>
<span class="k">                    end if</span>

                    <span class="c">! recursive print of the element</span>
                    <span class="k">call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">iunit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">tab</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span>
                                          <span class="n">need_comma</span><span class="o">=</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">,</span> <span class="n">colon</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>

                    <span class="c">! get the next child the list:</span>
                    <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">element</span><span class="p">%</span><span class="n">next</span>

                <span class="k">end do</span>

                <span class="c">! [one fewer tab if it isn&#39;t an array element]</span>
                <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">is_array</span><span class="p">)</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">spaces</span><span class="o">-</span><span class="n">spaces_per_tab</span><span class="p">))</span>
                <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">end_object</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>
                <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

            <span class="k">end if</span>

<span class="k">        case</span> <span class="p">(</span><span class="n">json_array</span><span class="p">)</span>

            <span class="nb">count</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!special case for empty array</span>

                <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">start_array</span><span class="o">//</span><span class="n">end_array</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>

            <span class="k">else</span>

<span class="k">                call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">start_array</span> <span class="p">)</span>

                <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>
                <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">count</span>

                    <span class="c">! recursive print of the element</span>
                    <span class="k">call </span><span class="n">json_value_print</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">iunit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">tab</span><span class="p">,&amp;</span>
                                          <span class="n">need_comma</span><span class="o">=</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">,</span> <span class="n">is_array_element</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>

                    <span class="c">! get the next child the list:</span>
                    <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">element</span><span class="p">%</span><span class="n">next</span>

                <span class="k">end do</span>

                <span class="c">!indent the closing array character:</span>
                <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">spaces</span><span class="o">-</span><span class="n">spaces_per_tab</span><span class="p">))</span><span class="o">//</span><span class="n">end_array</span><span class="p">,&amp;</span>
                               <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>
                <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

            <span class="k">end if</span>

<span class="k">        case</span> <span class="p">(</span><span class="n">json_null</span><span class="p">)</span>

            <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">null_str</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>

        <span class="k">case</span> <span class="p">(</span><span class="n">json_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">quotation_mark</span><span class="o">//</span> <span class="p">&amp;</span>
                               <span class="nb">trim</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span><span class="p">)</span><span class="o">//</span><span class="n">quotation_mark</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>
            <span class="k">else</span>
<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_print:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; me%value_string not allocated&#39;</span><span class="p">)</span>
                <span class="k">return</span>
<span class="k">            end if</span>

<span class="k">        case</span> <span class="p">(</span><span class="n">json_logical</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">true_str</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>
            <span class="k">else</span>
<span class="k">                call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="n">false_str</span><span class="p">,</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>
            <span class="k">end if</span>

<span class="k">        case</span> <span class="p">(</span><span class="n">json_integer</span><span class="p">)</span>

            <span class="k">call </span><span class="n">integer_to_string</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">int_value</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>

            <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>

        <span class="k">case</span> <span class="p">(</span><span class="n">json_double</span><span class="p">)</span>

            <span class="k">call </span><span class="n">real_to_string</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>

            <span class="k">call </span><span class="n">write_it</span><span class="p">(</span> <span class="n">s</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">comma</span><span class="o">=</span><span class="n">print_comma</span> <span class="p">)</span>

        <span class="k">case </span><span class="n">default</span>

            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_value_print: unknown data type&#39;</span><span class="p">)</span>

        <span class="k">end select</span>

        <span class="c">!cleanup:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    contains</span>

    <span class="c">!</span>
    <span class="c">! write the string to the file (or the output string)</span>
    <span class="c">!</span>
        <span class="k">subroutine </span><span class="n">write_it</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">advance</span><span class="p">,</span><span class="n">comma</span><span class="p">)</span>

        <span class="k">implicit none</span>

<span class="k">        </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">s</span>        <span class="c">!string to print</span>
        <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">advance</span>  <span class="c">!to add line break or not</span>
        <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">comma</span>    <span class="c">!print comma after the string</span>

        <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">add_line_break</span><span class="p">,</span> <span class="n">add_comma</span>
        <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">s2</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">comma</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">add_comma</span> <span class="o">=</span> <span class="n">comma</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">add_comma</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span> <span class="c">!default is not to add comma</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">advance</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">add_line_break</span> <span class="o">=</span> <span class="n">advance</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">add_line_break</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span> <span class="c">!default is to advance</span>
        <span class="k">end if</span>

        <span class="c">!string to print:</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">add_comma</span><span class="p">)</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">//</span> <span class="n">delimiter</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">write_file</span><span class="p">)</span> <span class="k">then</span>

<span class="k">            if</span> <span class="p">(</span><span class="n">add_line_break</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="n">s2</span>
            <span class="k">else</span>
<span class="k">                write</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;NO&#39;</span><span class="p">)</span> <span class="n">s2</span>
            <span class="k">end if</span>

<span class="k">        else</span>    <span class="c">!write string</span>

            <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">//</span> <span class="n">s2</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">add_line_break</span><span class="p">)</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">//</span> <span class="n">newline</span>

        <span class="k">end if</span>

        <span class="c">!cleanup:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

        <span class="k">end subroutine </span><span class="n">write_it</span>

    <span class="k">end subroutine </span><span class="n">json_value_print</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Returns the [[json_value]] pointer given the path string.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: dat,p</span>
<span class="c">!     logical :: found</span>
<span class="c">!     !...</span>
<span class="c">!     call json_get(dat,&#39;data(2).version&#39;,p,found)</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# Notes</span>
<span class="c">!  The following special characters are used to denote paths:</span>
<span class="c">!</span>
<span class="c">!```</span>
<span class="c">!  $         - root</span>
<span class="c">!  @         - this</span>
<span class="c">!  .         - child object member</span>
<span class="c">!  [] or ()  - child array element</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!  Thus, if any of these characters are present in the name key,</span>
<span class="c">!  this routine cannot be used to get the value.</span>
<span class="c">!  In that case, the [[json_get_child]] routines would need to be used.</span>

    <span class="k">subroutine </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">path</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>  <span class="c">!! true if it was found</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">start_array_alt</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">end_array_alt</span>   <span class="o">=</span> <span class="s1">&#39;)&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">root</span>            <span class="o">=</span> <span class="s1">&#39;$&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">this</span>            <span class="o">=</span> <span class="s1">&#39;@&#39;</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">child</span>           <span class="o">=</span> <span class="s1">&#39;.&#39;</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">child_i</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span>              <span class="kd">::</span> <span class="k">array</span>
<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c">! default to assuming relative to this</span>
        <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span>

        <span class="n">child_i</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">array</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

        <span class="n">length</span> <span class="o">=</span> <span class="nb">len_trim</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span>

            <span class="n">c</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span>

            <span class="k">select case</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">case</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>

                <span class="c">! root</span>
                <span class="k">do while</span> <span class="p">(</span><span class="nb">associated</span> <span class="p">(</span><span class="n">p</span><span class="p">%</span><span class="n">parent</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">p</span><span class="p">%</span><span class="n">parent</span>
                <span class="k">end do</span>
<span class="k">                </span><span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">this</span><span class="p">)</span>

                <span class="c">! this</span>
                <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">me</span>
                <span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span>

                <span class="c">! get child member from p</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">child_i</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                    nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">call </span><span class="n">json_get_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">(</span><span class="n">child_i</span><span class="p">:</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tmp</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">tmp</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">else</span>
<span class="k">                    </span><span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">cycle</span>
<span class="k">                end if</span>

<span class="k">                if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                    call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_by_path:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                         <span class="s1">&#39; Error getting child member.&#39;</span><span class="p">)</span>
                    <span class="k">exit</span>
<span class="k">                end if</span>

<span class="k">                </span><span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">start_array</span><span class="p">,</span><span class="n">start_array_alt</span><span class="p">)</span>

                <span class="c">!....Modified to allow for &#39;var[3]&#39; style syntax</span>
                <span class="c">!Note: jmozmoz/fson has a slightly different version of this...</span>

                <span class="c">! start looking for the array element index</span>
                <span class="k">array</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>

                <span class="c">! get child member from p</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">child_i</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                    nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">call </span><span class="n">json_get_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">(</span><span class="n">child_i</span><span class="p">:</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tmp</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">tmp</span>
                    <span class="k">nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">else</span>
<span class="k">                    </span><span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">cycle</span>
<span class="k">                end if</span>
<span class="k">                if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                    call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_by_path:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                         <span class="s1">&#39; Error getting array element&#39;</span><span class="p">)</span>
                    <span class="k">exit</span>
<span class="k">                end if</span>
<span class="k">                </span><span class="n">child_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">end_array</span><span class="p">,</span><span class="n">end_array_alt</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="k">array</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                    call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_by_path: Unexpected ]&#39;</span><span class="p">)</span>
                    <span class="k">exit</span>
<span class="k">                end if</span>
<span class="k">                array</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                <span class="n">child_i</span> <span class="o">=</span> <span class="n">string_to_integer</span><span class="p">(</span><span class="n">path</span><span class="p">(</span><span class="n">child_i</span><span class="p">:</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

                <span class="k">nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">call </span><span class="n">json_get_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">child_i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">tmp</span>
                <span class="k">nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

                <span class="n">child_i</span><span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">end select</span>

<span class="k">        end do</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">            if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
            <span class="k">end if</span>

<span class="k">        else</span>

            <span class="c">! grab the last child if present in the path</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">child_i</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">call </span><span class="n">json_get_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">path</span><span class="p">(</span><span class="n">child_i</span><span class="p">:</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=&gt;</span> <span class="n">tmp</span>
                <span class="k">nullify</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">end if</span>
<span class="k">            if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>    <span class="c">!everything seems to be ok</span>
            <span class="k">else</span>
<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_by_path:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; variable not found: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                    </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                    <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
                <span class="k">end if</span>
<span class="k">            end if</span>

<span class="k">        end if</span>

<span class="k">    else</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_by_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_by_path]] where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_by_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Convert a string into an integer.</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams : 12/10/2013 : Rewrote routine.  Added error checking.</span>
<span class="c">!  * Modified by Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!@note Replacement for the parse_integer function in the original code.</span>

    <span class="k">function </span><span class="n">string_to_integer</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ival</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="nb">digits</span>
<span class="nb">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ndigits_digits</span><span class="p">,</span><span class="n">ndigits</span><span class="p">,</span><span class="n">ierr</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">! Compute how many digits we need to read</span>
        <span class="n">ndigits</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len_trim</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="n">ndigits_digits</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">ndigits</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">allocate</span><span class="p">(</span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">ndigits_digits</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">digits</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="nb">digits</span><span class="p">,</span><span class="s1">&#39;(I0)&#39;</span><span class="p">)</span> <span class="n">ndigits</span> <span class="c">!gfortran will have a runtime error with * edit descriptor here</span>
        <span class="c">! gfortran bug: &#39;*&#39; edit descriptor for ISO_10646 strings does bad stuff.</span>
        <span class="k">read</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s1">&#39;(I&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="nb">digits</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span> <span class="n">ival</span>   <span class="c">!string to integer</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!if there was an error</span>
            <span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in string_to_integer:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; string cannot be converted to an integer: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="k">    else</span>
<span class="k">        </span><span class="n">ival</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">end if</span>

<span class="k">    end function </span><span class="n">string_to_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/19/2014</span>
<span class="c">!</span>
<span class="c">!  Convert a string into a double.</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams, 10/27/2015 : Now using fmt=*, rather than</span>
<span class="c">!    fmt=real_fmt, since it doesn&#39;t work for some unusual cases</span>
<span class="c">!    (e.g., when str=&#39;1E-5&#39;).</span>

    <span class="k">function </span><span class="n">string_to_double</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">rval</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ierr</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!string to double</span>
        <span class="k">read</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">fmt</span><span class="o">=*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span> <span class="n">rval</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!if there was an error</span>
            <span class="n">rval</span> <span class="o">=</span> <span class="mf">0.0_RK</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in string_to_double:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; string cannot be converted to a double: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="k">    end if</span>

<span class="k">    end function </span><span class="n">string_to_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get an integer value from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="k">value</span>

<span class="k">    value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">return</span>

<span class="k">    select case</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_integer</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">int_value</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_double</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_logical</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span>
<span class="k">            value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">end if</span>
<span class="k">    case </span><span class="n">default</span>
        <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in get_integer:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39; Unable to resolve value to integer: &#39;</span><span class="o">//</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end select</span>

<span class="k">    end subroutine </span><span class="n">json_get_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get an integer value from a [[json_value]], given the path string.</span>

    <span class="k">subroutine </span><span class="n">json_get_integer_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">       if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
       <span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_integer:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
            <span class="s1">&#39; Unable to resolve path: &#39;</span><span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="n">json_get_integer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">value</span><span class="p">)</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">end if</span>
<span class="k">    if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
        <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_integer_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_integer_with_path]], where &quot;path&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_integer_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>              <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_integer_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_integer_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 5/14/2014</span>
<span class="c">!</span>
<span class="c">!  Get an integer vector from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_integer_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                         <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_int_from_array</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for integer</span>
        <span class="k">subroutine </span><span class="n">get_int_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_int_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_integer_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get an integer vector from a [[json_value]], given the path string.</span>

    <span class="k">subroutine </span><span class="n">json_get_integer_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                         <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_int_from_array</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="c">! need to duplicate callback function, no other way</span>
    <span class="k">contains</span>

        <span class="c">! callback function for integer</span>
        <span class="k">subroutine </span><span class="n">get_int_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_int_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_integer_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_integer_vec_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_integer_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                         <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_integer_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span><span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_integer_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a double value from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>     <span class="kd">::</span> <span class="k">value</span>

<span class="k">    value</span> <span class="o">=</span> <span class="mf">0.0_RK</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">return</span>

<span class="k">    select case</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_integer</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">int_value</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_double</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_logical</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            value</span> <span class="o">=</span> <span class="mf">1.0_RK</span>
        <span class="k">else</span>
<span class="k">            value</span> <span class="o">=</span> <span class="mf">0.0_RK</span>
        <span class="k">end if</span>
<span class="k">    case </span><span class="n">default</span>

        <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_double:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39; Unable to resolve value to double: &#39;</span><span class="o">//</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end select</span>

<span class="k">    end subroutine </span><span class="n">json_get_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a double value from a [[json_value]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_double_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">value</span> <span class="o">=</span> <span class="mf">0.0_RK</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_double:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39; Unable to resolve path: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">else</span>

<span class="k">        call </span><span class="n">json_get_double</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">value</span><span class="p">)</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
        <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_double_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_double_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_double_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                 <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_double_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="k">value</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_double_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 5/14/2014</span>
<span class="c">!</span>
<span class="c">!  Get a double vector from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_double_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_double_from_array</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for double</span>
        <span class="k">subroutine </span><span class="n">get_double_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_double_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_double_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a double vector from a [[json_value]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_double_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_double_from_array</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for double</span>
        <span class="k">subroutine </span><span class="n">get_double_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_double_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_double_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_double_vec_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_double_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>                      <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_double_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_double_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a logical value from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span>                         <span class="kd">::</span> <span class="k">value</span>

<span class="k">    value</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">return</span>

<span class="k">    select case</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_integer</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">int_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_logical</span><span class="p">)</span>
        <span class="k">value</span> <span class="o">=</span> <span class="n">me</span> <span class="p">%</span> <span class="n">log_value</span>
    <span class="k">case </span><span class="n">default</span>
        <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_logical:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39; Unable to resolve value to logical: &#39;</span><span class="o">//</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end select</span>

<span class="k">    end subroutine </span><span class="n">json_get_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a logical value from a [[json_value]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_logical_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span>                         <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">value</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_logical:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39; Unable to resolve path: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">else</span>

<span class="k">        call </span><span class="n">json_get_logical</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">value</span><span class="p">)</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
        <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_logical_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_logical_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_logical_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span>                          <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_logical_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="k">value</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_logical_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 5/14/2014</span>
<span class="c">!</span>
<span class="c">!  Get a logical vector from [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_logical_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_logical_from_array</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for logical</span>
        <span class="k">subroutine </span><span class="n">get_logical_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_logical_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_logical_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a logical vector from a [[json_value]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_logical_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_logical_from_array</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for logical</span>
        <span class="k">subroutine </span><span class="n">get_logical_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">end subroutine </span><span class="n">get_logical_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_logical_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_logical_vec_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_logical_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_logical_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="n">vec</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_logical_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a character string from a [[json_value]].</span>

    <span class="k">subroutine </span><span class="n">json_get_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="k">value</span>

<span class="k">    value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        select case</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>

        <span class="k">case</span> <span class="p">(</span><span class="n">json_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">unescape_string</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>
            <span class="k">else</span>
<span class="k">               call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                    <span class="s1">&#39; me%str_value not allocated&#39;</span><span class="p">)</span>
            <span class="k">end if</span>

<span class="k">        case </span><span class="n">default</span>

            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                 <span class="s1">&#39; Unable to resolve value to characters: &#39;</span><span class="o">//</span><span class="n">me</span><span class="p">%</span><span class="n">name</span><span class="p">)</span>

            <span class="c">! Note: for the other cases, we could do val to string conversions.</span>

        <span class="k">end select</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Remove the escape characters from a JSON string and return it.</span>
<span class="c">!</span>
<span class="c">!  The escaped characters are denoted by the &#39;\&#39; character:</span>
<span class="c">!````</span>
<span class="c">!    &#39;\&quot;&#39;        quotation mark</span>
<span class="c">!    &#39;\\&#39;        reverse solidus</span>
<span class="c">!    &#39;\/&#39;        solidus</span>
<span class="c">!    &#39;\b&#39;        backspace</span>
<span class="c">!    &#39;\f&#39;        formfeed</span>
<span class="c">!    &#39;\n&#39;        newline (LF)</span>
<span class="c">!    &#39;\r&#39;        carriage return (CR)</span>
<span class="c">!    &#39;\t&#39;        horizontal tab</span>
<span class="c">!    &#39;\uXXXX&#39;    4 hexadecimal digits</span>
<span class="c">!````</span>

    <span class="k">subroutine </span><span class="n">unescape_string</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span> <span class="n">str_out</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">str_in</span>  <span class="c">!! string as stored in a [[json_value]]</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str_out</span> <span class="c">!! decoded string</span>

    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>   <span class="c">!! counter</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>   <span class="c">!! length of str_in</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">m</span>   <span class="c">!! length of str_out</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>  <span class="c">!! for scanning each character in string</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">scan</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span><span class="n">backslash</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!there is at least one escape character, so process this string:</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_in</span><span class="p">)</span>
        <span class="n">str_out</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c">!size the output string (will be trimmed later)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!counter in str_out</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!counter in str_in</span>

        <span class="k">do</span>

<span class="k">            </span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">n</span><span class="p">)</span> <span class="k">exit</span> <span class="c">! finished</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">str_in</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="c">! get next character in the string</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">backslash</span><span class="p">)</span> <span class="k">then</span>

<span class="k">                if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">)</span> <span class="k">then</span>

<span class="k">                    </span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">str_in</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="c">!character after the escape</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="p">[</span><span class="n">quotation_mark</span><span class="p">,</span><span class="n">backslash</span><span class="p">,</span><span class="n">slash</span><span class="p">,</span> <span class="p">&amp;</span>
                         <span class="n">to_unicode</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">])]))</span> <span class="k">then</span>

<span class="k">                        select case</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">quotation_mark</span><span class="p">,</span><span class="n">backslash</span><span class="p">,</span><span class="n">slash</span><span class="p">)</span>
                            <span class="c">!use d as is</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                             <span class="n">c</span> <span class="o">=</span> <span class="n">bspace</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                             <span class="n">c</span> <span class="o">=</span> <span class="n">formfeed</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
                             <span class="n">c</span> <span class="o">=</span> <span class="n">newline</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                             <span class="n">c</span> <span class="o">=</span> <span class="n">carriage_return</span>
                        <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                             <span class="n">c</span> <span class="o">=</span> <span class="n">horizontal_tab</span>
                        <span class="k">end select</span>

<span class="k">                        </span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">str_out</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>

                    <span class="k">else if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="c">!expecting 4 hexadecimal digits after</span>
                                            <span class="c">!the escape character    [\uXXXX]</span>

                        <span class="c">!for now, we are just returning them as is</span>
                        <span class="c">![not checking to see if it is a valid hex value]</span>
                        <span class="c">!</span>
                        <span class="c">! Example:</span>
                        <span class="c">!   123456</span>
                        <span class="c">!   \uXXXX</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                            </span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">str_out</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_in</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">5</span>
                        <span class="k">else</span>
<span class="k">                            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="s1">&#39; Invalid hexadecimal sequence&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="s1">&#39; in string: &#39;</span><span class="o">//</span><span class="n">str_in</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:))</span>
                            <span class="n">str_out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">return</span>
<span class="k">                        end if</span>

<span class="k">                    else</span>
                        <span class="c">!unknown escape character</span>
                        <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                             <span class="s1">&#39; unknown escape sequence in string &quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                             <span class="nb">trim</span><span class="p">(</span><span class="n">str_in</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; [&#39;</span><span class="o">//</span><span class="n">backslash</span><span class="o">//</span><span class="n">c</span><span class="o">//</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                        <span class="n">str_out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">return</span>
<span class="k">                    end if</span>

<span class="k">                else</span>
                    <span class="c">!an escape character is the last character in</span>
                    <span class="c">! the string [this may not be valid syntax,</span>
                    <span class="c">! but just keep it]</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">str_out</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                <span class="k">end if</span>

<span class="k">            else</span>
<span class="k">                </span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">str_out</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">end if</span>

<span class="k">        end do</span>

        <span class="c">!trim trailing space:</span>
        <span class="n">str_out</span> <span class="o">=</span> <span class="n">str_out</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">m</span><span class="p">)</span>

    <span class="k">else</span>
        <span class="c">!there are no escape characters, so return as is:</span>
        <span class="n">str_out</span> <span class="o">=</span> <span class="n">str_in</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">unescape_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a character string from a [[json_value]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_string_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                             <span class="s1">&#39; Unable to resolve path: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">else</span>

<span class="k">        call </span><span class="n">json_get_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="k">value</span><span class="p">)</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="k">else</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
        <span class="k">end if</span>
<span class="k">    end if</span>

    <span class="c">!cleanup:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_get_string_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_string_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_string_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="k">value</span>
<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_string_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="k">value</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_string_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 5/14/2014</span>
<span class="c">!</span>
<span class="c">!  Get a string vector from a [[json_file(type)]].</span>

    <span class="k">subroutine </span><span class="n">json_get_string_vec</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_chars_from_array</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for chars</span>
        <span class="k">subroutine </span><span class="n">get_chars_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>

        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">cval</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">cval</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">cval</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">cval</span>
            <span class="k">deallocate</span><span class="p">(</span><span class="n">cval</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">end if</span>

<span class="k">        end subroutine </span><span class="n">get_chars_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_string_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get a string vector from a [[json_file(type)]], given the path.</span>

    <span class="k">subroutine </span><span class="n">json_get_string_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                              <span class="kd">::</span> <span class="n">found</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">initialized</span>

    <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="c">!the callback function is called for each element of the array:</span>
    <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="o">=</span><span class="n">get_chars_from_array</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="n">found</span><span class="p">)</span>

    <span class="k">contains</span>

        <span class="c">! callback function for chars</span>
        <span class="k">subroutine </span><span class="n">get_chars_from_array</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>

        <span class="k">implicit none</span>

<span class="k">        type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">element</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">i</span>        <span class="c">!index</span>
        <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nb">count</span>    <span class="c">!size of array</span>

        <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">cval</span>

        <span class="c">!size the output array:</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">initialized</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            allocate</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="nb">count</span><span class="p">))</span>
            <span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="k">end if</span>

        <span class="c">!populate the elements:</span>
        <span class="k">call </span><span class="n">json_get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">cval</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">cval</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">cval</span>
            <span class="k">deallocate</span><span class="p">(</span><span class="n">cval</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">vec</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">end if</span>

<span class="k">        end subroutine </span><span class="n">get_chars_from_array</span>

    <span class="k">end subroutine </span><span class="n">json_get_string_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_string_vec_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_string_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">path</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vec</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>                              <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_string_vec_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="n">vec</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_string_vec_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  This routine calls the user-supplied [[array_callback_func]] subroutine</span>
<span class="c">!      for each element in the array.</span>
<span class="c">!</span>
<span class="c">!@note For integer, double, logical, and character arrays,</span>
<span class="c">!      higher-level routines are provided (see [[json_get]]), so</span>
<span class="c">!      this routine does not have to be used for those cases.</span>

    <span class="k">subroutine </span><span class="n">json_get_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">array_callback</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="k">procedure</span><span class="p">(</span><span class="n">array_callback_func</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">array_callback</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">element</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span>

<span class="nb">    </span><span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">return</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">select case</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">json_array</span><span class="p">)</span>
        <span class="nb">count</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">count</span> <span class="c">! callback for each child</span>
            <span class="k">call </span><span class="n">array_callback</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=&gt;</span> <span class="n">element</span><span class="p">%</span><span class="n">next</span>
        <span class="k">end do</span>
<span class="k">    case </span><span class="n">default</span>

        <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_array:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39; Resolved value is not an array &#39;</span><span class="p">)</span>

    <span class="k">end select</span>

    <span class="c">!cleanup:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_get_array</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 09/02/2015</span>
<span class="c">!</span>
<span class="c">!  Traverse a JSON structure.</span>
<span class="c">!  This routine calls the user-specified [[traverse_callback_func]]</span>
<span class="c">!  for each element of the structure.</span>
<span class="c">!</span>
    <span class="k">recursive subroutine </span><span class="n">json_traverse</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">traverse_callback</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="k">procedure</span><span class="p">(</span><span class="n">traverse_callback_func</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">traverse_callback</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">element</span>  <span class="c">!! a child element</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>        <span class="c">!! counter</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">icount</span>   <span class="c">!! number of children</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">finished</span> <span class="c">!! can be used to stop the process</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">return</span>

<span class="k">    call </span><span class="n">traverse_callback</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">finished</span><span class="p">)</span> <span class="c">! first call for this object</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">finished</span><span class="p">)</span> <span class="k">return</span>

    <span class="c">!for arrays and objects, have to also call for all children:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="o">==</span><span class="n">json_array</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">me</span><span class="p">%</span><span class="n">var_type</span><span class="o">==</span><span class="n">json_object</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">icount</span> <span class="o">=</span> <span class="n">json_count</span><span class="p">(</span><span class="n">me</span><span class="p">)</span> <span class="c">! number of children</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">icount</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">element</span> <span class="o">=&gt;</span> <span class="n">me</span><span class="p">%</span><span class="n">children</span>  <span class="c">! first one</span>
            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">icount</span>        <span class="c">! call for each child</span>
                <span class="k">call </span><span class="n">json_traverse</span><span class="p">(</span><span class="n">element</span><span class="p">,</span><span class="n">traverse_callback</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">finished</span><span class="p">)</span> <span class="k">exit</span>
<span class="k">                </span><span class="n">element</span> <span class="o">=&gt;</span> <span class="n">element</span><span class="p">%</span><span class="n">next</span>
            <span class="k">end do</span>
<span class="k">        end if</span>
<span class="k">        nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_traverse</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  This routine calls the user-supplied array_callback subroutine</span>
<span class="c">!  for each element in the array (specified by the path).</span>

    <span class="k">subroutine </span><span class="n">json_get_array_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="k">procedure</span><span class="p">(</span><span class="n">array_callback_func</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">array_callback</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>    <span class="kd">::</span> <span class="n">found</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">p</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">! resolve the path to the value</span>
    <span class="k">call </span><span class="n">json_get_by_path</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_get_array:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39; Unable to resolve path: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">else</span>
<span class="k">       call </span><span class="n">json_get_array</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">array_callback</span><span class="o">=</span><span class="n">array_callback</span><span class="p">)</span>
       <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">end if</span>
<span class="k">    if</span> <span class="p">(</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
            <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
        <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">        if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">)</span> <span class="n">found</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_get_array_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_get_array_with_path]], where &quot;path&quot; is kind=CDK</span>

    <span class="k">subroutine </span><span class="n">wrap_json_get_array_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">array_callback</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">path</span>
    <span class="k">procedure</span><span class="p">(</span><span class="n">array_callback_func</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">array_callback</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">found</span>

    <span class="k">call </span><span class="n">json_get_array_with_path</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">array_callback</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_get_array_with_path</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Parse the JSON file and populate the [[json_value]] tree.</span>
<span class="c">!</span>
<span class="c">!# Inputs</span>
<span class="c">!</span>
<span class="c">!  The inputs can be:</span>
<span class="c">!</span>
<span class="c">!  * file and unit : the specified unit is used to read JSON from file.</span>
<span class="c">!                    [note if unit is already open, then the filename is ignored]</span>
<span class="c">!  * file          : JSON is read from file using internal unit number</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!</span>
<span class="c">!```fortran</span>
<span class="c">!    type(json_value),pointer :: p</span>
<span class="c">!    call json_parse(file=&#39;myfile.json&#39;, p=p)</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams : 01/13/2015 : added read from string option.</span>
<span class="c">!  * Izaak Beekman  : 03/08/2015 : moved read from string to separate</span>
<span class="c">!    subroutine, and error annotation</span>
<span class="c">!    to separate subroutine.</span>
<span class="c">!</span>
<span class="c">!@note When calling this routine, any exceptions thrown from previous</span>
<span class="c">!      calls will automatically be cleared.</span>

    <span class="k">subroutine </span><span class="n">json_parse_file</span><span class="p">(</span><span class="k">file</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="k">file</span>  <span class="c">!! JSON file name</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>     <span class="c">!! output structure</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>      <span class="kd">::</span> <span class="n">unit</span>  <span class="c">!! file unit number (/= 0)</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iunit</span><span class="p">,</span> <span class="n">istat</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">is_open</span>

    <span class="c">!clear any exceptions and initialize:</span>
    <span class="k">call </span><span class="n">json_initialize</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nb">present</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">unit</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_parse_file: unit number must not be 0.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        end if</span>

<span class="k">        </span><span class="n">iunit</span> <span class="o">=</span> <span class="n">unit</span>

        <span class="c">!check to see if the file is already open</span>
        <span class="c">! if it is, then use it, otherwise open the file with the name given.</span>
        <span class="k">inquire</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">opened</span><span class="o">=</span><span class="n">is_open</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">is_open</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! open the file</span>
            <span class="k">open</span> <span class="p">(</span>  <span class="n">unit</span>        <span class="o">=</span> <span class="n">iunit</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="k">file</span>        <span class="o">=</span> <span class="k">file</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">status</span>      <span class="o">=</span> <span class="s1">&#39;OLD&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">action</span>      <span class="o">=</span> <span class="s1">&#39;READ&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">form</span>        <span class="o">=</span> <span class="n">form_spec</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="nb">access</span>      <span class="o">=</span> <span class="n">access_spec</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">iostat</span>      <span class="o">=</span> <span class="n">istat</span> <span class="p">&amp;</span>
                    <span class="n">FILE_ENCODING</span> <span class="p">)</span>
        <span class="k">else</span>
            <span class="c">!if the file is already open, then we need to make sure</span>
            <span class="c">! that it is open with the correct form/access/etc...</span>
        <span class="k">end if</span>

<span class="k">    else</span>

        <span class="c">! open the file with a new unit number:</span>
        <span class="k">open</span> <span class="p">(</span>  <span class="n">newunit</span>     <span class="o">=</span> <span class="n">iunit</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="k">file</span>        <span class="o">=</span> <span class="k">file</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="n">status</span>      <span class="o">=</span> <span class="s1">&#39;OLD&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="n">action</span>      <span class="o">=</span> <span class="s1">&#39;READ&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="n">form</span>        <span class="o">=</span> <span class="n">form_spec</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="nb">access</span>      <span class="o">=</span> <span class="n">access_spec</span><span class="p">,</span> <span class="p">&amp;</span>
                <span class="n">iostat</span>      <span class="o">=</span> <span class="n">istat</span> <span class="p">&amp;</span>
                <span class="n">FILE_ENCODING</span> <span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">! create the value and associate the pointer</span>
        <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c">! Note: the name of the root json_value doesn&#39;t really matter,</span>
        <span class="c">!  but we&#39;ll allocate something here just in case.</span>
        <span class="n">p</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="k">file</span><span class="p">)</span>  <span class="c">!use the file name</span>

        <span class="c">! parse as a value</span>
        <span class="k">call </span><span class="n">parse_value</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">CK_</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">annotate_invalid_json</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c">! close the file if necessary</span>
        <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>

    <span class="k">else</span>

<span class="k">        call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in json_parse_file: Error opening file: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="k">file</span><span class="p">))</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_parse_file</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Parse the JSON string and populate the [[json_value]] tree.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[json_parse_file]]</span>

    <span class="k">subroutine </span><span class="n">json_parse_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">p</span>     <span class="c">!! output structure</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>   <span class="c">!! string with JSON data</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">iunit</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!indicates that json data will be read from buffer</span>

    <span class="k">if</span> <span class="p">(</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span> <span class="p">)</span> <span class="k">then</span>

        <span class="c">!clear any exceptions and initialize:</span>
        <span class="k">call </span><span class="n">json_initialize</span><span class="p">()</span>

        <span class="c">! create the value and associate the pointer</span>
        <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c">! Note: the name of the root json_value doesn&#39;t really matter,</span>
        <span class="c">!  but we&#39;ll allocate something here just in case.</span>
        <span class="n">p</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c">! parse as a value</span>
        <span class="k">call </span><span class="n">parse_value</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">annotate_invalid_json</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_parse_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Alternate version of [[json_parse_string]], where &quot;str&quot; is kind=CDK.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_parse_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">p</span>     <span class="c">!! output structure</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>   <span class="c">!! string with JSON data</span>

    <span class="k">call </span><span class="n">json_parse_string</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_parse_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Generate a warning message if there was an error parsing a JSON</span>
<span class="c">!  file or string.</span>

    <span class="k">subroutine </span><span class="n">annotate_invalid_json</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iunit</span>             <span class="c">!! file unit number</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>  <span class="c">!! string with JSON data</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">line</span><span class="p">,</span> <span class="n">arrow_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="kd">::</span> <span class="n">line_str</span><span class="p">,</span> <span class="n">char_str</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_nl_prev</span><span class="p">,</span> <span class="n">i_nl</span>

    <span class="c">!</span>
    <span class="c">!  If there was an error reading the file, then</span>
    <span class="c">!   print the line where the error occurred:</span>
    <span class="c">!</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!the counters for the current line and the last character read:</span>
        <span class="k">call </span><span class="n">integer_to_string</span><span class="p">(</span><span class="n">line_count</span><span class="p">,</span> <span class="n">line_str</span><span class="p">)</span>
        <span class="k">call </span><span class="n">integer_to_string</span><span class="p">(</span><span class="n">char_count</span><span class="p">,</span> <span class="n">char_str</span><span class="p">)</span>

        <span class="c">!draw the arrow string that points to the current character:</span>
        <span class="n">arrow_str</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">char_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">//</span><span class="s1">&#39;^&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">line_count</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">char_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">            if</span> <span class="p">(</span><span class="n">iunit</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">                if</span> <span class="p">(</span><span class="n">use_unformatted_stream</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                    call </span><span class="n">get_current_line_from_file_stream</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span>
<span class="k">                    call </span><span class="n">get_current_line_from_file_sequential</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
                <span class="k">end if</span>

<span class="k">            else</span>

                <span class="c">!get the current line from the string:</span>
                <span class="c">! [this is done by counting the newline characters]</span>
                <span class="n">i_nl_prev</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!index of previous newline character</span>
                <span class="n">i_nl</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c">!just in case line_count = 0</span>
                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">line_count</span>
                    <span class="n">i_nl</span> <span class="o">=</span> <span class="nb">index</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">i_nl_prev</span><span class="o">+</span><span class="mi">1</span><span class="p">:),</span><span class="n">newline</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i_nl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>   <span class="c">!last line - no newline character</span>
                        <span class="n">i_nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                        <span class="k">exit</span>
<span class="k">                    end if</span>
<span class="k">                    </span><span class="n">i_nl</span> <span class="o">=</span> <span class="n">i_nl</span> <span class="o">+</span> <span class="n">i_nl_prev</span>   <span class="c">!index of current newline character</span>
                    <span class="n">i_nl_prev</span> <span class="o">=</span> <span class="n">i_nl</span>          <span class="c">!update for next iteration</span>
                <span class="k">end do</span>
<span class="k">                </span><span class="n">line</span> <span class="o">=</span> <span class="n">str</span><span class="p">(</span><span class="n">i_nl_prev</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">i_nl</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c">!extract current line</span>

            <span class="k">end if</span>

<span class="k">        else</span>
            <span class="c">!in this case, it was an empty line or file</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">end if</span>

        <span class="c">!create the error message:</span>
        <span class="n">err_message</span> <span class="o">=</span> <span class="n">err_message</span><span class="o">//</span><span class="n">newline</span><span class="o">//</span><span class="p">&amp;</span>
                      <span class="s1">&#39;line: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">line_str</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;, &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                      <span class="s1">&#39;character: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">char_str</span><span class="p">))</span><span class="o">//</span><span class="n">newline</span><span class="o">//</span><span class="p">&amp;</span>
                      <span class="nb">trim</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">//</span><span class="n">newline</span><span class="o">//</span><span class="n">arrow_str</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">annotate_invalid_json</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Rewind the file to the beginning of the current line, and return this line.</span>
<span class="c">!  The file is assumed to be opened.</span>
<span class="c">!  This is the SEQUENTIAL version (see also [[get_current_line_from_file_stream]]).</span>

    <span class="k">subroutine </span><span class="n">get_current_line_from_file_sequential</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">iunit</span>  <span class="c">!! file unit number</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">line</span>   <span class="c">!! current line</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">parameter</span>               <span class="kd">::</span> <span class="n">n_chunk</span> <span class="o">=</span> <span class="mi">256</span>   <span class="c">! chunk size [arbitrary]</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">nfmt</span> <span class="o">=</span> <span class="s1">&#39;(A256)&#39;</span> <span class="c">! corresponding format statement</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">n_chunk</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chunk</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istat</span><span class="p">,</span><span class="n">isize</span>

    <span class="c">!initialize:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c">!rewind to beginning of the current record:</span>
    <span class="k">backspace</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>

    <span class="c">!loop to read in all the characters in the current record.</span>
    <span class="c">![the line is read in chunks until the end of the line is reached]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        do</span>
<span class="k">            </span><span class="n">isize</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">read</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">nfmt</span><span class="p">,</span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;NO&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">isize</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">chunk</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">//</span><span class="n">chunk</span>
            <span class="k">else</span>
<span class="k">                if</span> <span class="p">(</span><span class="n">isize</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">isize</span><span class="o">&lt;=</span><span class="n">n_chunk</span><span class="p">)</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">//</span><span class="n">chunk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">isize</span><span class="p">)</span>
                <span class="k">exit</span>
<span class="k">            end if</span>
<span class="k">        end do</span>
<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">get_current_line_from_file_sequential</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Rewind the file to the beginning of the current line, and return this line.</span>
<span class="c">!  The file is assumed to be opened.</span>
<span class="c">!  This is the STREAM version (see also [[get_current_line_from_file_sequential]]).</span>

    <span class="k">subroutine </span><span class="n">get_current_line_from_file_stream</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">iunit</span>  <span class="c">!! file unit number</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">line</span>   <span class="c">!! current line</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istart</span><span class="p">,</span><span class="n">iend</span><span class="p">,</span><span class="n">ios</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>

    <span class="c">!updated for the new STREAM version:</span>

    <span class="n">istart</span> <span class="o">=</span> <span class="n">ipos</span>
    <span class="k">do</span>
<span class="k">        if</span> <span class="p">(</span><span class="n">istart</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">istart</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">exit</span>
<span class="k">        end if</span>
<span class="k">        read</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">istart</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span> <span class="n">c</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="n">newline</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">ios</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">istart</span><span class="o">/=</span><span class="mi">1</span><span class="p">)</span> <span class="n">istart</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">exit</span>
<span class="k">        end if</span>
<span class="k">        </span><span class="n">istart</span> <span class="o">=</span> <span class="n">istart</span><span class="o">-</span><span class="mi">1</span>  <span class="c">!rewind until the beginning of the line</span>
    <span class="k">end do</span>
<span class="k">    </span><span class="n">iend</span> <span class="o">=</span> <span class="n">ipos</span>
    <span class="k">do</span>
<span class="k">        read</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">iend</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span> <span class="n">c</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="n">newline</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">ios</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">exit</span>
<span class="k">        </span><span class="n">iend</span><span class="o">=</span><span class="n">iend</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">end do</span>
<span class="k">    allocate</span><span class="p">(</span> <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">iend</span><span class="o">-</span><span class="n">istart</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">line</span> <span class="p">)</span>
    <span class="k">read</span><span class="p">(</span><span class="n">iunit</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">istart</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span> <span class="n">line</span>

    <span class="k">end subroutine </span><span class="n">get_current_line_from_file_stream</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Core parsing routine.</span>

    <span class="k">recursive subroutine </span><span class="n">parse_value</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>   <span class="c">!! file unit number</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>    <span class="c">!! string containing JSON data (only used if unit=0)</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="k">value</span>  <span class="c">!! JSON data that is extracted</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">tmp</span>  <span class="c">!this is a work-around for a bug</span>
                                                 <span class="c">! in the gfortran 4.9 compiler.</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!the routine is being called incorrectly.</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="k">value</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_value: value pointer not associated.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

        <span class="c">! pop the next non whitespace character off the file</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            return</span>
<span class="k">        else</span>
<span class="k">            select case</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">case</span> <span class="p">(</span><span class="n">start_object</span><span class="p">)</span>

                <span class="c">! start object</span>
                <span class="k">call </span><span class="n">to_object</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>    <span class="c">!allocate class</span>
                <span class="k">call </span><span class="n">parse_object</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">start_array</span><span class="p">)</span>

                <span class="c">! start array</span>
                <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>    <span class="c">!allocate class</span>
                <span class="k">call </span><span class="n">parse_array</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">end_array</span><span class="p">)</span>

                <span class="c">! end an empty array</span>
                <span class="k">call </span><span class="n">push_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">nullify</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">quotation_mark</span><span class="p">)</span>

                <span class="c">! string</span>
                <span class="k">call </span><span class="n">to_string</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>    <span class="c">!allocate class</span>

                <span class="k">select case</span> <span class="p">(</span><span class="k">value</span><span class="p">%</span><span class="n">var_type</span><span class="p">)</span>
                <span class="k">case</span> <span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
                    <span class="k">call </span><span class="n">parse_string</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>  <span class="c">!write to a tmp variable because of</span>
                    <span class="k">value</span><span class="p">%</span><span class="n">str_value</span> <span class="o">=</span> <span class="n">tmp</span>              <span class="c">! a bug in 4.9 gfortran compiler.</span>
                    <span class="k">deallocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>                    <span class="c">!</span>
                <span class="k">end select</span>

<span class="k">            case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;t&#39;</span><span class="p">)</span> <span class="c">!true_str(1:1) gfortran bug work around</span>

                <span class="c">!true</span>
                <span class="k">call </span><span class="n">parse_for_chars</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">true_str</span><span class="p">(</span><span class="mi">2</span><span class="p">:))</span>
                <span class="c">!allocate class and set value:</span>
                <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">to_logical</span><span class="p">(</span><span class="k">value</span><span class="p">,.</span><span class="n">true</span><span class="p">.)</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="c">!false_str(1:1) gfortran bug work around</span>

                <span class="c">!false</span>
                <span class="k">call </span><span class="n">parse_for_chars</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">false_str</span><span class="p">(</span><span class="mi">2</span><span class="p">:))</span>
                <span class="c">!allocate class and set value:</span>
                <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">to_logical</span><span class="p">(</span><span class="k">value</span><span class="p">,.</span><span class="n">false</span><span class="p">.)</span>

            <span class="k">case</span> <span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="c">!null_str(1:1) gfortran bug work around</span>

                <span class="c">!null</span>
                <span class="k">call </span><span class="n">parse_for_chars</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">null_str</span><span class="p">(</span><span class="mi">2</span><span class="p">:))</span>
                <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">call </span><span class="n">to_null</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>    <span class="c">!allocate class</span>

            <span class="k">case</span><span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">CK_</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="n">CK_</span><span class="s1">&#39;9&#39;</span><span class="p">)</span>

                <span class="k">call </span><span class="n">push_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">call </span><span class="n">parse_number</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

            <span class="k">case </span><span class="n">default</span>

                <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_value:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; Unexpected character while parsing value. &quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="n">c</span><span class="o">//</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

            <span class="k">end select</span>
<span class="k">        end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">parse_value</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a [[json_value]] pointer and make it a logical(LK) variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;value&#39;,.true.)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! variable name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! variable value</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Wrapper for [[json_value_create_logical]] so [[json_create_logical]] can</span>
<span class="c">!  be called with name of character kind &#39;DEFAULT&#39; or &#39;ISO_10646&#39;</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a [[json_value]] pointer and make it an integer(IK) variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;value&#39;,1)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  A wrapper procedure for [[json_value_create_integer]] so that [[json_create_integer]]</span>
<span class="c">!  may be called with either a &#39;DEFAULT&#39; or &#39;ISO_10646&#39; character kind &#39;name&#39;</span>
<span class="c">!  actual argument.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a [[json_value]] pointer and make it a real(RK) variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;value&#39;,1.0d0)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  A wrapper for [[json_value_create_double]] so that [[json_create_double]] may be</span>
<span class="c">!  called with an actual argument corresponding to the dummy argument, &#39;name&#39;</span>
<span class="c">!  that may be of &#39;DEFAULT&#39; or &#39;ISO_10646&#39; character kind.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a json_value pointer and make it a string variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;value&#39;,&#39;hello&#39;)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Wrap [[json_value_create_string]] so that [[json_create_string]] may be called with actual</span>
<span class="c">!  character string arguments for &#39;name&#39; and &#39;val&#39; that are BOTH of &#39;DEFAULT&#39; or</span>
<span class="c">!  &#39;ISO_10646&#39; character kind.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">val</span>

    <span class="k">call </span><span class="n">json_value_create_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a json_value pointer and make it a null variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;value&#39;)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_null</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_null</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_null</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Wrap [[json_value_create_null]] so that [[json_create_null]] may be called with an actual</span>
<span class="c">!  argument corresponding to the dummy argument &#39;name&#39; that is either of &#39;DEFAULT&#39; or</span>
<span class="c">!  &#39;ISO_10646&#39; character kind.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_null</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create_null</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_null</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a [[json_value]] pointer and make it an object variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;objectname&#39;)</span>
<span class="c">!```</span>
<span class="c">!</span>
<span class="c">!@note The name is not significant for the root structure or an array element.</span>
<span class="c">!      In those cases, an empty string can be used.</span>

    <span class="k">subroutine </span><span class="n">json_value_create_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Wrap [[json_value_create_object]] so that [[json_create_object]] may be called with an actual</span>
<span class="c">!  argument corresponding to the dummy argument &#39;name&#39; that is of either &#39;DEFAULT&#39; or</span>
<span class="c">!  &#39;ISO_10646&#39; character kind.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Allocate a [[json_value]] pointer and make it an array variable.</span>
<span class="c">!  The pointer should not already be allocated.</span>
<span class="c">!</span>
<span class="c">!# Example</span>
<span class="c">!```fortran</span>
<span class="c">!     type(json_value),pointer :: p</span>
<span class="c">!     call json_create(p,&#39;arrayname&#39;)</span>
<span class="c">!```</span>

    <span class="k">subroutine </span><span class="n">json_value_create_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="k">call </span><span class="n">to_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">json_value_create_array</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  A wrapper for [[json_value_create_array]] so that [[json_create_array]] may be called with</span>
<span class="c">!  an actual argument, corresponding to the dummy argument &#39;name&#39;, that is either of</span>
<span class="c">!  &#39;DEFAULT&#39; or &#39;ISO_10646&#39; character kind.</span>

    <span class="k">subroutine </span><span class="n">wrap_json_value_create_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>             <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">name</span>

    <span class="k">call </span><span class="n">json_value_create_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">end subroutine </span><span class="n">wrap_json_value_create_array</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to a logical.</span>

    <span class="k">subroutine </span><span class="n">to_logical</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! if the value is also to be set (if not present, then .false. is used).</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_logical</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">log_value</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>    <span class="c">!default value</span>
    <span class="k">end if</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_logical</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to an integer.</span>

    <span class="k">subroutine </span><span class="n">to_integer</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>              <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! if the value is also to be set (if not present, then 0 is used).</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_integer</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">int_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">int_value</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">int_value</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c">!default value</span>
    <span class="k">end if</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_integer</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to a double.</span>

    <span class="k">subroutine </span><span class="n">to_double</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>                 <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! if the value is also to be set (if not present, then 0.0_rk is used).</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_double</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">dbl_value</span> <span class="o">=</span> <span class="mf">0.0_RK</span>    <span class="c">!default value</span>
    <span class="k">end if</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_double</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to a string.</span>
<span class="c">!</span>
<span class="c">!# Modified</span>
<span class="c">!  * Izaak Beekman : 02/24/2015</span>
<span class="c">!</span>

    <span class="k">subroutine </span><span class="n">to_string</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">val</span>   <span class="c">!! if the value is also to be set (if not present, then &#39;&#39; is used).</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_string</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">me</span><span class="p">%</span><span class="n">str_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c">!default value</span>
    <span class="k">end if</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to a null.</span>

    <span class="k">subroutine </span><span class="n">to_null</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_null</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_null</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to an object.</span>

    <span class="k">subroutine </span><span class="n">to_object</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_object</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Change the [[json_value]] variable to an array.</span>

    <span class="k">subroutine </span><span class="n">to_array</span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span> <span class="kd">::</span> <span class="n">name</span>  <span class="c">!! if the name is also to be changed.</span>

    <span class="c">!set type and value:</span>
    <span class="k">call </span><span class="n">destroy_json_data</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">me</span><span class="p">%</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">json_array</span>

    <span class="c">!name:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="n">me</span><span class="p">%</span><span class="n">name</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">end subroutine </span><span class="n">to_array</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Core parsing routine.</span>

    <span class="k">recursive subroutine </span><span class="n">parse_object</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>    <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>     <span class="c">!! JSON string (if parsing from a string)</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="n">parent</span>  <span class="c">!! the parsed object will be added as a child of this</span>

    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">pair</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">tmp</span>  <span class="c">!! this is a work-around for a bug</span>
                                                 <span class="c">!! in the gfortran 4.9 compiler.</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!the routine is being called incorrectly.</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">associated</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object: parent pointer not associated.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        nullify</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>    <span class="c">!probably not necessary</span>

        <span class="c">! pair name</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; Unexpected end of file while parsing start of object.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">end_object</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! end of an empty object</span>
            <span class="k">return</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">quotation_mark</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
            <span class="k">call </span><span class="n">parse_string</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>   <span class="c">!write to a tmp variable because of</span>
            <span class="n">pair</span> <span class="p">%</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tmp</span>                   <span class="c">! a bug in 4.9 gfortran compiler.</span>
            <span class="k">deallocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">json_destroy</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="k">return</span>
<span class="k">            end if</span>
<span class="k">        else</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object: Expecting string: &quot;&#39;</span><span class="o">//</span><span class="n">c</span><span class="o">//</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        end if</span>

        <span class="c">! pair value</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; Unexpected end of file while parsing object member.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">colon_char</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! parse the value</span>
            <span class="k">call </span><span class="n">parse_value</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">json_destroy</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="k">return</span>
<span class="k">            else</span>
<span class="k">                call </span><span class="n">json_add</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
            <span class="k">end if</span>
<span class="k">        else</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39; Expecting : and then a value: &#39;</span><span class="o">//</span><span class="n">c</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        end if</span>

        <span class="c">! another possible pair</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;End of file encountered when parsing an object&#39;</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! read the next member</span>
            <span class="k">call </span><span class="n">parse_object</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">else if</span> <span class="p">(</span><span class="n">end_object</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! end of object</span>
            <span class="k">return</span>
<span class="k">        else</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_object: Expecting end of object: &#39;</span><span class="o">//</span><span class="n">c</span><span class="p">)</span>
            <span class="k">return</span>
<span class="k">        end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">parse_object</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Core parsing routine.</span>

    <span class="k">recursive subroutine </span><span class="n">parse_array</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">array</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>   <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>    <span class="c">!! JSON string (if parsing from a string)</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="k">array</span>

<span class="k">    type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span> <span class="kd">::</span> <span class="n">element</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>

    <span class="k">do</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">exit</span>

        <span class="c">! try to parse an element value</span>
        <span class="k">nullify</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">call </span><span class="n">json_value_create</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">call </span><span class="n">parse_value</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="k">call </span><span class="n">json_destroy</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">exit</span>
<span class="k">        end if</span>

        <span class="c">! parse value will disassociate an empty array value</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="k">call </span><span class="n">json_add</span><span class="p">(</span><span class="k">array</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

        <span class="c">! popped the next character</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! The file ended before array was finished:</span>
            <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_array: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;End of file encountered when parsing an array.&#39;</span><span class="p">)</span>
            <span class="k">exit</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! parse the next element</span>
            <span class="k">cycle</span>
<span class="k">        else if</span> <span class="p">(</span><span class="n">end_array</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">then</span>
            <span class="c">! end of array</span>
            <span class="k">exit</span>
<span class="k">        else</span>
<span class="k">            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_array: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                 <span class="s1">&#39;Unexpected character encountered when parsing array.&#39;</span><span class="p">)</span>
            <span class="k">exit</span>
<span class="k">        end if</span>

<span class="k">    end do</span>

<span class="k">    end subroutine </span><span class="n">parse_array</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Parses a string while reading a JSON file.</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams : 6/16/2014 : Added hex validation.</span>
<span class="c">!  * Jacob Williams : 12/3/2015 : Fixed some bugs.</span>

    <span class="k">subroutine </span><span class="n">parse_string</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                           <span class="kd">::</span> <span class="n">unit</span>  <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">str</span>   <span class="c">!! JSON string (if parsing from a string)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">string</span>

    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span><span class="p">,</span> <span class="n">is_hex</span><span class="p">,</span> <span class="n">escape</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hex</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ip</span> <span class="c">!! index to put next character,</span>
                      <span class="c">!! to speed up by reducing the number of character string reallocations.</span>

    <span class="c">!at least return a blank string if there is a problem:</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!initialize:</span>
        <span class="n">ip</span>     <span class="o">=</span> <span class="mi">1</span>
        <span class="n">is_hex</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="n">i</span>      <span class="o">=</span> <span class="mi">0</span>

        <span class="k">do</span>

            <span class="c">!get the next character from the file:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>

<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_string: Expecting end of string&#39;</span><span class="p">)</span>
                <span class="k">return</span>

<span class="k">            else if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="n">quotation_mark</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span> <span class="n">escape</span><span class="p">)</span> <span class="k">then</span>  <span class="c">!end of string</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">is_hex</span><span class="p">)</span> <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="s1">&#39; incomplete hex string: \u&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">hex</span><span class="p">))</span>
                <span class="k">exit</span>

<span class="k">            else</span>

                <span class="c">!if the string is not big enough, then add another chunk:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">))</span> <span class="n">string</span> <span class="o">=</span> <span class="n">string</span> <span class="o">//</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>

                <span class="c">!append to string:</span>
                <span class="n">string</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c">!hex validation:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_hex</span><span class="p">)</span> <span class="k">then</span>  <span class="c">!accumulate the four characters after &#39;\u&#39;</span>

                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">hex</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                        if</span> <span class="p">(</span><span class="n">valid_json_hex</span><span class="p">(</span><span class="n">hex</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                            </span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">hex</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">is_hex</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                        <span class="k">else</span>
<span class="k">                            call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_string:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="s1">&#39; invalid hex string: \u&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">hex</span><span class="p">))</span>
                            <span class="k">exit</span>
<span class="k">                        end if</span>
<span class="k">                    end if</span>

<span class="k">                else</span>

                    <span class="c">!when the &#39;\u&#39; string is encountered, then</span>
                    <span class="c">!  start accumulating the hex string (should be the next 4 characters)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">escape</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                        </span><span class="n">escape</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
                        <span class="n">is_hex</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>    <span class="c">!the next four characters are the hex string</span>
                    <span class="k">else</span>
<span class="k">                        </span><span class="n">escape</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="n">backslash</span><span class="p">)</span>
                    <span class="k">end if</span>

<span class="k">                end if</span>

<span class="k">            end if</span>

<span class="k">        end do</span>

        <span class="c">!trim the string if necessary:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">ip</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ip</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">end if</span>
<span class="k">        end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">parse_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Core parsing routine.</span>

    <span class="k">subroutine </span><span class="n">parse_for_chars</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">chars</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>   <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>    <span class="c">!! JSON string (if parsing from a string)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chars</span>  <span class="c">!! the string to check for.</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">length</span> <span class="o">=</span> <span class="nb">len_trim</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_for_chars:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; Unexpected end of file while parsing array.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
<span class="k">            else if</span> <span class="p">(</span><span class="n">c</span> <span class="o">/=</span> <span class="n">chars</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_for_chars:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; Unexpected character.: &quot;&#39;</span><span class="o">//</span><span class="n">c</span><span class="o">//</span><span class="s1">&#39;&quot; &#39;</span><span class="o">//</span><span class="n">chars</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">))</span>
                <span class="k">return</span>
<span class="k">            end if</span>
<span class="k">        end do</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">parse_for_chars</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 1/20/2014</span>
<span class="c">!</span>
<span class="c">!  Read a numerical value from the file (or string).</span>
<span class="c">!  The routine will determine if it is an integer or a double, and</span>
<span class="c">!  allocate the type accordingly.</span>
<span class="c">!</span>
<span class="c">!@note Complete rewrite of the original FSON routine, which had some problems.</span>

    <span class="k">subroutine </span><span class="n">parse_number</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>   <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>    <span class="c">!! JSON string (if parsing from a string)</span>
    <span class="k">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">),</span><span class="k">pointer</span>            <span class="kd">::</span> <span class="k">value</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">tmp</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eof</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rval</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ival</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">first</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">is_integer</span>

    <span class="c">!to speed up by reducing the number of character string reallocations:</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ip</span> <span class="c">!index to put next character</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">tmp</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">first</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
        <span class="n">is_integer</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>  <span class="c">!assume it may be an integer, unless otherwise determined</span>

        <span class="c">!read one character at a time and accumulate the string:</span>
        <span class="k">do</span>

            <span class="c">!get the next character:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="o">=</span><span class="n">str</span><span class="p">,</span> <span class="n">eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">eof</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in parse_number:&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39; Unexpected end of file while parsing number.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
<span class="k">            else</span>

<span class="k">                select case</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">case</span><span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>    <span class="c">!note: allowing a &#39;+&#39; as the first character here.</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">is_integer</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">first</span><span class="p">))</span> <span class="n">is_integer</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

                    <span class="c">!add it to the string:</span>
                    <span class="c">!tmp = tmp // c   !...original</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">//</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">case</span><span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>    <span class="c">!can be present in real numbers</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">is_integer</span><span class="p">)</span> <span class="n">is_integer</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

                    <span class="c">!add it to the string:</span>
                    <span class="c">!tmp = tmp // c   !...original</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">//</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">case</span><span class="p">(</span><span class="n">CK_</span><span class="s1">&#39;0&#39;</span><span class="p">:</span><span class="n">CK_</span><span class="s1">&#39;9&#39;</span><span class="p">)</span>    <span class="c">!valid characters for numbers</span>

                    <span class="c">!add it to the string:</span>
                    <span class="c">!tmp = tmp // c   !...original</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">//</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">case </span><span class="n">default</span>

                    <span class="c">!push back the last character read:</span>
                    <span class="k">call </span><span class="n">push_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                    <span class="c">!string to value:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">is_integer</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                        </span><span class="n">ival</span> <span class="o">=</span> <span class="n">string_to_integer</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                        <span class="k">call </span><span class="n">to_integer</span><span class="p">(</span><span class="k">value</span><span class="p">,</span><span class="n">ival</span><span class="p">)</span>
                    <span class="k">else</span>
<span class="k">                        </span><span class="n">rval</span> <span class="o">=</span> <span class="n">string_to_double</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                        <span class="k">call </span><span class="n">to_double</span><span class="p">(</span><span class="k">value</span><span class="p">,</span><span class="n">rval</span><span class="p">)</span>
                    <span class="k">end if</span>

<span class="k">                    exit</span>    <span class="c">!finished</span>

                <span class="k">end select</span>

<span class="k">            end if</span>
<span class="k">            if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="n">first</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

        <span class="k">end do</span>

        <span class="c">!cleanup:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">parse_number</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Get the next character from the file (or string).</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[push_char]]</span>
<span class="c">!</span>
<span class="c">!@note This routine ignores non-printing ASCII characters (iachar&lt;=31) that are in strings.</span>

    <span class="k">recursive function </span><span class="n">pop_char</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">eof</span><span class="p">,</span> <span class="n">skip_ws</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">popped</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">popped</span>  <span class="c">!! the popped character.</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">unit</span>    <span class="c">!! file unit number (if parsing from a file)</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>     <span class="c">!! JSON string (if parsing from a string) -- only used if unit=0</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">eof</span>     <span class="c">!! true if the end of the file has been reached.</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>     <span class="kd">::</span> <span class="n">skip_ws</span> <span class="c">!! to ignore whitespace.</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ios</span><span class="p">,</span><span class="n">str_len</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ignore</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">present</span><span class="p">(</span><span class="n">skip_ws</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">ignore</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
        <span class="k">else</span>
<span class="k">            </span><span class="n">ignore</span> <span class="o">=</span> <span class="n">skip_ws</span>
        <span class="k">end if</span>

<span class="k">        do</span>

<span class="k">            if</span> <span class="p">(</span><span class="n">pushed_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

                <span class="c">! there is a character pushed back on, most likely from the number parsing</span>
                <span class="c">! NOTE: this can only occur if reading from a file when use_unformatted_stream=.false.</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">pushed_char</span><span class="p">(</span><span class="n">pushed_index</span><span class="p">:</span><span class="n">pushed_index</span><span class="p">)</span>
                <span class="n">pushed_index</span> <span class="o">=</span> <span class="n">pushed_index</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">else</span>

<span class="k">                if</span> <span class="p">(</span><span class="n">unit</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!read from the file</span>

                    <span class="c">!read the next character:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">use_unformatted_stream</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                        read</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">ipos</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span> <span class="n">c</span>
                    <span class="k">else</span>
<span class="k">                        read</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A1)&#39;</span><span class="p">,</span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;NO&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span> <span class="n">c</span>
                    <span class="k">end if</span>
<span class="k">                    </span><span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c">!....note: maybe try read the file in chunks...</span>
                    <span class="c">!.... or use asynchronous read with double buffering</span>
                    <span class="c">!     (see Modern Fortran: Style and Usage)</span>

                <span class="k">else</span>    <span class="c">!read from the string</span>

                    <span class="n">str_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>   <span class="c">!length of the string</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ipos</span><span class="o">&lt;=</span><span class="n">str_len</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                        </span><span class="n">c</span> <span class="o">=</span> <span class="n">str</span><span class="p">(</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="p">)</span>
                        <span class="n">ios</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span>
<span class="k">                        </span><span class="n">ios</span> <span class="o">=</span> <span class="n">IOSTAT_END</span>  <span class="c">!end of the string</span>
                    <span class="k">end if</span>
<span class="k">                    </span><span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">end if</span>

<span class="k">                </span><span class="n">char_count</span> <span class="o">=</span> <span class="n">char_count</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c">!character count in the current line</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">IS_IOSTAT_END</span><span class="p">(</span><span class="n">ios</span><span class="p">))</span> <span class="k">then</span>  <span class="c">!end of file</span>

                    <span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
                    <span class="k">exit</span>

<span class="k">                </span><span class="n">elseif</span> <span class="p">(</span><span class="nb">IS_IOSTAT_EOR</span><span class="p">(</span><span class="n">ios</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">c</span><span class="o">==</span><span class="n">newline</span><span class="p">)</span> <span class="k">then</span>    <span class="c">!end of record</span>

                    <span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">line_count</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">cycle</span>

<span class="k">                end if</span>

<span class="k">            end if</span>

<span class="k">            if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">control_chars</span><span class="p">))</span> <span class="k">then</span>

                <span class="c">! non printing ascii characters</span>
                <span class="k">cycle</span>

<span class="k">            else if</span> <span class="p">(</span><span class="n">ignore</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">c</span> <span class="o">==</span> <span class="n">space</span><span class="p">)</span> <span class="k">then</span>

<span class="k">                cycle</span>

<span class="k">            else</span>

<span class="k">                </span><span class="n">popped</span> <span class="o">=</span> <span class="n">c</span>
                <span class="k">exit</span>

<span class="k">            end if</span>

<span class="k">        end do</span>

<span class="k">    end if</span>

<span class="k">    end function </span><span class="n">pop_char</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt;</span>
<span class="c">!  Core routine.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[pop_char]]</span>
<span class="c">!</span>
<span class="c">!# History</span>
<span class="c">!  * Jacob Williams : 5/3/2015 : replaced original version of this routine.</span>

    <span class="k">subroutine </span><span class="n">push_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">max_numeric_str_len</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istr</span>

    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">exception_thrown</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">use_unformatted_stream</span><span class="p">)</span> <span class="k">then</span>

            <span class="c">!in this case, c is ignored, and we just</span>
            <span class="c">!decrement the stream position counter:</span>
            <span class="n">ipos</span> <span class="o">=</span> <span class="n">ipos</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">else</span>

<span class="k">            </span><span class="n">pushed_index</span> <span class="o">=</span> <span class="n">pushed_index</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pushed_index</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">pushed_index</span><span class="o">&lt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">pushed_char</span><span class="p">))</span> <span class="k">then</span>
<span class="k">                </span><span class="n">pushed_char</span><span class="p">(</span><span class="n">pushed_index</span><span class="p">:</span><span class="n">pushed_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">else</span>
<span class="k">                call </span><span class="n">integer_to_string</span><span class="p">(</span><span class="n">pushed_index</span><span class="p">,</span><span class="n">istr</span><span class="p">)</span>
                <span class="k">call </span><span class="n">throw_exception</span><span class="p">(</span><span class="s1">&#39;Error in push_char: &#39;</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39;invalid valid of pushed_index: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">istr</span><span class="p">))</span>
            <span class="k">end if</span>

<span class="k">        end if</span>

<span class="k">    end if</span>

<span class="k">    end subroutine </span><span class="n">push_char</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Convert an integer to a string.</span>

    <span class="k">pure subroutine </span><span class="n">integer_to_string</span><span class="p">(</span><span class="n">ival</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">ival</span>  <span class="c">!! integer value.</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>   <span class="c">!! ival converted to a string.</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istat</span>

    <span class="k">write</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">int_fmt</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">ival</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">str</span> <span class="o">=</span> <span class="nb">adjustl</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        </span><span class="n">str</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">integer_to_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date: 12/4/2013</span>
<span class="c">!</span>
<span class="c">!  Convert a real value to a string.</span>
<span class="c">!</span>
<span class="c">!# Modified</span>
<span class="c">!  * Izaak Beekman : 02/24/2015 : added the compact option.</span>
<span class="c">!  * Jacob Williams : 10/27/2015 : added the star option.</span>

    <span class="k">subroutine </span><span class="n">real_to_string</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="n">RK</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">rval</span>  <span class="c">!! real value.</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>   <span class="c">!! rval converted to a string.</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istat</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">real_fmt</span><span class="o">==</span><span class="n">star</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        write</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">fmt</span><span class="o">=*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">rval</span>
    <span class="k">else</span>
<span class="k">        write</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">real_fmt</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span> <span class="n">rval</span>
    <span class="k">end if</span>

<span class="k">    if</span> <span class="p">(</span><span class="n">istat</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!in this case, the default string will be compacted,</span>
        <span class="c">! so that the same value is displayed with fewer characters.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">compact_real</span><span class="p">)</span> <span class="k">call </span><span class="n">compact_real_string</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

    <span class="k">else</span>
<span class="k">        </span><span class="n">str</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">real_to_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!  date: 02/24/2015</span>
<span class="c">!</span>
<span class="c">!  Compact a string representing a real number, so that</span>
<span class="c">!  the same value is displayed with fewer characters.</span>
<span class="c">!</span>
<span class="c">!# See also</span>
<span class="c">!  * [[real_to_string]]</span>

    <span class="k">subroutine </span><span class="n">compact_real_string</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>  <span class="c">!! string representation of a real number.</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="kd">::</span> <span class="n">significand</span><span class="p">,</span> <span class="n">expnt</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="kd">::</span> <span class="n">separator</span>
    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">exp_start</span><span class="p">,</span><span class="n">decimal_pos</span><span class="p">,</span><span class="n">sig_trim</span><span class="p">,</span><span class="n">exp_trim</span><span class="p">,</span><span class="n">i</span>

    <span class="n">str</span> <span class="o">=</span> <span class="nb">adjustl</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="n">exp_start</span> <span class="o">=</span> <span class="nb">scan</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;eEdD&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exp_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">exp_start</span> <span class="o">=</span> <span class="nb">scan</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;-+&#39;</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>
    <span class="n">decimal_pos</span> <span class="o">=</span> <span class="nb">scan</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="n">CK_</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exp_start</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">separator</span> <span class="o">=</span> <span class="n">str</span><span class="p">(</span><span class="n">exp_start</span><span class="p">:</span><span class="n">exp_start</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">exp_start</span> <span class="o">&lt;</span> <span class="n">decimal_pos</span> <span class="p">)</span> <span class="k">then</span> <span class="c">!possibly signed, exponent-less float</span>

        <span class="n">significand</span> <span class="o">=</span> <span class="n">str</span>
        <span class="n">sig_trim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">significand</span><span class="p">))</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">significand</span><span class="p">)),</span><span class="n">decimal_pos</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="c">!look from right to left at 0s</span>
                                                       <span class="c">!but save one after the decimal place</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">significand</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">sig_trim</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span>
<span class="k">                exit</span>
<span class="k">            end if</span>
<span class="k">        end do</span>
<span class="k">        </span><span class="n">str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">significand</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">sig_trim</span><span class="p">))</span>

    <span class="k">else if</span> <span class="p">(</span><span class="n">exp_start</span> <span class="o">&gt;</span> <span class="n">decimal_pos</span><span class="p">)</span> <span class="k">then</span> <span class="c">!float has exponent</span>

        <span class="n">significand</span> <span class="o">=</span> <span class="n">str</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">exp_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sig_trim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">significand</span><span class="p">))</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">significand</span><span class="p">)),</span><span class="n">decimal_pos</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="c">!look from right to left at 0s</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">significand</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">sig_trim</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span>
<span class="k">                exit</span>
<span class="k">            end if</span>
<span class="k">        end do</span>
<span class="k">        </span><span class="n">expnt</span> <span class="o">=</span> <span class="nb">adjustl</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">exp_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expnt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">expnt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">separator</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span><span class="o">//</span><span class="n">expnt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exp_start</span> <span class="o">=</span> <span class="n">exp_start</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">expnt</span>     <span class="o">=</span> <span class="nb">adjustl</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">exp_start</span><span class="o">+</span><span class="mi">1</span><span class="p">:))</span>
        <span class="k">end if</span>
<span class="k">        </span><span class="n">exp_trim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">expnt</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!look at exponent leading zeros saving last</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">expnt</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="n">exp_trim</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span>
<span class="k">                exit</span>
<span class="k">            end if</span>
<span class="k">        end do</span>
<span class="k">        </span><span class="n">str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">significand</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">sig_trim</span><span class="p">)))</span><span class="o">//</span> <span class="p">&amp;</span>
              <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span><span class="o">//</span> <span class="p">&amp;</span>
              <span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">expnt</span><span class="p">(</span><span class="n">exp_trim</span><span class="p">:)))</span>

    <span class="c">!else ! mal-formed real, BUT this code should be unreachable</span>

    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">compact_real_string</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!  date:6/14/2014</span>
<span class="c">!</span>
<span class="c">!  Returns true if the string is a valid 4-digit hex string.</span>
<span class="c">!</span>
<span class="c">!# Examples</span>
<span class="c">!```fortran</span>
<span class="c">!    valid_json_hex(&#39;0000&#39;)  !returns true</span>
<span class="c">!    valid_json_hex(&#39;ABC4&#39;)  !returns true</span>
<span class="c">!    valid_json_hex(&#39;AB&#39;)    !returns false (&lt; 4 characters)</span>
<span class="c">!    valid_json_hex(&#39;WXYZ&#39;)  !returns false (invalid characters)</span>
<span class="c">!```</span>

    <span class="k">pure function </span><span class="n">valid_json_hex</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span>                         <span class="kd">::</span> <span class="n">valid</span>  <span class="c">!! is str a value 4-digit hex string</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>    <span class="c">!! the string to check.</span>

    <span class="kt">integer</span><span class="p">(</span><span class="n">IK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span>

    <span class="c">!an array of the valid hex characters:</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="n">valid_chars</span> <span class="o">=</span> <span class="p">&amp;</span>
        <span class="p">[</span> <span class="p">(</span><span class="nb">achar</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span><span class="mi">57</span><span class="p">),</span> <span class="p">&amp;</span> <span class="c">! decimal digits</span>
          <span class="p">(</span><span class="nb">achar</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span><span class="mi">70</span><span class="p">),</span> <span class="p">&amp;</span> <span class="c">! capital A-F</span>
          <span class="p">(</span><span class="nb">achar</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">97</span><span class="p">,</span><span class="mi">102</span><span class="p">)</span> <span class="p">]</span> <span class="c">! lowercase a-f</span>

    <span class="c">!initialize</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>

    <span class="c">!check all the characters in the string:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
            <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="nb">any</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="n">valid_chars</span><span class="p">))</span> <span class="k">return</span>
<span class="k">        end do</span>
<span class="k">        </span><span class="n">valid</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>    <span class="c">!all are in the set, so it is OK</span>
    <span class="k">end if</span>

<span class="k">    end function </span><span class="n">valid_json_hex</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Convert string to unicode (CDK to CK).</span>

    <span class="k">pure function </span><span class="n">to_uni</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">))</span>       <span class="kd">::</span> <span class="n">to_uni</span>

    <span class="n">to_uni</span> <span class="o">=</span> <span class="n">str</span>

    <span class="k">end function </span><span class="n">to_uni</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  Convert array of strings to unicode (CDK to CK).</span>
<span class="c">!</span>
<span class="c">!@note JW: may be able to remove this by making [[to_uni]] PURE ELEMENTAL ?</span>

    <span class="k">pure function </span><span class="n">to_uni_vec</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">str</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="kd">::</span> <span class="n">to_uni_vec</span>

    <span class="n">to_uni_vec</span> <span class="o">=</span> <span class="n">str</span>

    <span class="k">end function </span><span class="n">to_uni_vec</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  CK//CDK operator.</span>

    <span class="k">function </span><span class="n">ucs4_join_default</span><span class="p">(</span><span class="n">ucs4_str</span><span class="p">,</span><span class="n">def_str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ucs4_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">def_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ucs4_str</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">def_str</span><span class="p">)))</span> <span class="kd">::</span> <span class="n">res</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">ucs4_str</span><span class="o">//</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">def_str</span><span class="p">)</span>

    <span class="k">end function </span><span class="n">ucs4_join_default</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  CDK//CK operator.</span>

    <span class="k">function </span><span class="n">default_join_ucs4</span><span class="p">(</span><span class="n">def_str</span><span class="p">,</span><span class="n">ucs4_str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">def_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ucs4_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">def_str</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">ucs4_str</span><span class="p">)))</span> <span class="kd">::</span> <span class="n">res</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">def_str</span><span class="p">)</span><span class="o">//</span><span class="n">ucs4_str</span>

    <span class="k">end function </span><span class="n">default_join_ucs4</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  CK==CDK operator.</span>

    <span class="k">function </span><span class="n">ucs4_comp_default</span><span class="p">(</span><span class="n">ucs4_str</span><span class="p">,</span><span class="n">def_str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ucs4_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">def_str</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">res</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ucs4_str</span> <span class="o">==</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">def_str</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">end function </span><span class="n">ucs4_comp_default</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Izaak Beekman</span>
<span class="c">!</span>
<span class="c">!  CDK==CK operator.</span>

    <span class="k">function </span><span class="n">default_comp_ucs4</span><span class="p">(</span><span class="n">def_str</span><span class="p">,</span><span class="n">ucs4_str</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CDK</span><span class="p">,</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">def_str</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span> <span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ucs4_str</span>
    <span class="kt">logical</span><span class="p">(</span><span class="n">LK</span><span class="p">)</span> <span class="kd">::</span> <span class="n">res</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">def_str</span><span class="p">)</span> <span class="o">==</span> <span class="n">ucs4_str</span><span class="p">)</span>

    <span class="k">end function </span><span class="n">default_comp_ucs4</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
<span class="c">!&gt; author: Jacob Williams</span>
<span class="c">!</span>
<span class="c">!  Print any error message, and then clear the exceptions.</span>
<span class="c">!</span>
<span class="c">!@note This routine is used by the unit tests.</span>
<span class="c">!      It was originally in json_example.f90, and was</span>
<span class="c">!      moved here 2/26/2015 by Izaak Beekman.</span>

    <span class="k">subroutine </span><span class="n">json_print_error_message</span><span class="p">(</span><span class="n">io_unit</span><span class="p">)</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">io_unit</span>

    <span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">CK</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">error_msg</span>
    <span class="kt">logical</span> <span class="kd">::</span> <span class="n">status_ok</span>

    <span class="c">!get error message:</span>
    <span class="k">call </span><span class="n">json_check_for_errors</span><span class="p">(</span><span class="n">status_ok</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>

    <span class="c">!print it if there is one:</span>
    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">status_ok</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">io_unit</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">io_unit</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="n">error_msg</span>
        <span class="k">else</span>
<span class="k">            write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span> <span class="n">error_msg</span>
        <span class="k">end if</span>
<span class="k">        deallocate</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">call </span><span class="n">json_clear_exceptions</span><span class="p">()</span>
    <span class="k">end if</span>

<span class="k">    end subroutine </span><span class="n">json_print_error_message</span>
<span class="c">!*****************************************************************************************</span>

<span class="c">!*****************************************************************************************</span>
    <span class="k">end module </span><span class="n">json_module</span>
<span class="c">!*****************************************************************************************</span>
</pre></div>

    </section>
    </div>
  </div>

    <hr>
    <footer>
        <div class="row">
        <div class="col-md-6">&copy; 2015 JSON-Fortran was written by Jacob Williams. </div>
        <div class="col-md-6"><span class="pull-right">Documentation generated by <a href="https://github.com/cmacmackin/ford">FORD</a>.</span></div>
        </div>
        <br>
    </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>